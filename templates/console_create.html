<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Создание | Консоль</title>
  <style>
    :root {
      --bg: #0b1021;
      --panel: #0f162e;
      --border: rgba(255,255,255,0.08);
      --text: #f7f7f7;
      --muted: #c4c7d4;
      --accent: #ff3b30;
      --accent2: #19d1ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', 'JetBrains Mono', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(25,209,255,0.08), transparent 26%),
                  radial-gradient(circle at 85% 15%, rgba(255,59,48,0.1), transparent 32%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 36px 24px;
    }
    body.embedded { min-height:auto; padding:10px; background:transparent; }
    body.embedded .wrap { max-width:none; margin:0; }
    body.embedded .top { display:none; }
    body.embedded .card { border-radius:14px; box-shadow:none; padding:14px; background:rgba(15,22,46,0.92); }
    body.embedded .card::before { display:none; }

    .wrap { max-width: 860px; margin: 0 auto; }

    /* ── Header ── */
    .top {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 28px;
    }
    h1 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.02em; }
    .pill {
      padding: 5px 14px;
      border-radius: 999px;
      background: rgba(25,209,255,0.13);
      border: 1px solid rgba(25,209,255,0.22);
      color: #19d1ff;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    /* ── Card ── */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #19d1ff 0%, #3b7dff 50%, rgba(25,209,255,0) 100%);
    }

    /* ── Token field ── */
    #token-label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 0 0 5px;
      opacity: 0.7;
    }
    #token {
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      color: rgba(196,199,212,0.6);
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      padding: 8px 12px;
      margin-bottom: 24px;
      border-radius: 8px;
    }
    #token:focus { border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(25,209,255,0.1); color: var(--text); opacity: 1; }

    /* ── Form ── */
    form { margin-top: 4px; }
    label {
      display: block;
      margin: 18px 0 6px;
      color: var(--muted);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }
    input, select, textarea {
      width: 100%;
      padding: 11px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
      font-size: 14px;
      font-family: inherit;
      transition: border .2s, box-shadow .2s, background .2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 3px rgba(25,209,255,0.12);
      background: rgba(25,209,255,0.03);
    }
    input[type="color"] { height:42px; min-width:72px; padding:4px; border-radius:10px; cursor:pointer; }
    input[type="file"] { padding:9px 12px; cursor:pointer; color:var(--muted); }
    select option { background: var(--panel); }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    .hint { color:var(--muted); font-size:12px; margin:6px 0 0; line-height:1.55; }

    /* ── Actions row ── */
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 28px;
      padding-top: 22px;
      border-top: 1px solid var(--border);
      align-items: center;
    }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      color: #0b1021;
      background: linear-gradient(120deg, #19d1ff, #38e8ff);
      box-shadow: 0 6px 22px rgba(25,209,255,0.3);
      transition: box-shadow .2s, transform .12s;
    }
    .btn:hover { box-shadow: 0 10px 30px rgba(25,209,255,0.42); transform: translateY(-1px); }
    .btn.secondary {
      background: rgba(255,255,255,0.07);
      border: 1px solid var(--border);
      color: var(--muted);
      box-shadow: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background .15s, color .15s;
    }
    .btn.secondary:hover { background: rgba(255,255,255,0.12); color: var(--text); box-shadow: none; transform: none; }

    /* ── Status ── */
    .status { margin-top: 14px; font-size: 13px; color: var(--muted); white-space: pre-line; line-height: 1.55; }

    /* ── Block builder ── */
    .blocks-toolbar { display:flex; gap:8px; margin:12px 0; flex-wrap:wrap; }
    .btn.small {
      padding: 7px 12px;
      font-size: 12px;
      background: rgba(255,255,255,0.07);
      border: 1px solid var(--border);
      color: var(--muted);
      box-shadow: none;
    }
    .btn.small:hover { background:rgba(255,255,255,0.13); color:var(--text); transform:none; box-shadow:none; }
    .block-list { display:grid; gap:10px; margin-top:8px; }
    .block-item { border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:rgba(255,255,255,0.02); }
    .block-head { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
    .block-kind { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); }
    .block-actions { display:flex; gap:6px; }
    .block-preview { margin-top:10px; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .block-preview h4 { margin:0 0 8px; font-size:14px; color:var(--muted); }
    .preview-item { margin-bottom:10px; }
    .preview-item img { max-width:100%; border-radius:8px; border:1px solid var(--border); }
    .preview-item iframe { width:100%; height:260px; border:none; border-radius:8px; }
    .quick-time-list { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .quick-time-item { display:inline-flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); }
    .quick-time-item input { width:auto; padding:0; }

    /* ── Method builder ── */
    .method-builder { display:grid; gap:14px; grid-template-columns:minmax(320px,440px) 1fr; margin-top:14px; }
    .builder-pane, .preview-pane { border:1px solid var(--border); border-radius:14px; background:rgba(255,255,255,0.02); padding:14px; }
    .builder-title, .preview-title { margin:0 0 10px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); }
    .live-page { background:#f5f7fb; color:#1d2433; border-radius:12px; border:1px solid #dfe5f1; padding:24px; min-height:420px; }
    .live-header { text-align:center; margin-bottom:18px; }
    .live-badge { display:inline-block; padding:8px 14px; border-radius:999px; background:#eaf2ff; color:#2f5cab; font-size:12px; font-weight:700; margin-bottom:8px; }
    .live-title { margin:0; font-size:30px; line-height:1.2; font-weight:800; color:#17203a; }
    .live-desc { margin:10px auto 0; max-width:820px; color:#52607a; }
    .live-material-link { display:inline-block; margin-top:10px; padding:8px 12px; border-radius:10px; background:#1f6feb; color:#fff; font-weight:700; text-decoration:none; }
    .live-block { margin:16px 0; }
    .live-block h3 { margin:0 0 8px; font-size:25px; line-height:1.25; }
    .live-block p { margin:0; line-height:1.65; }
    .live-quote { border-left:4px solid #6d8ed6; background:#eaf0ff; color:#27334d; padding:12px 14px; border-radius:8px; }
    .live-block img { max-width:100%; border-radius:10px; border:1px solid #d8dfef; display:block; }
    .live-block iframe { width:100%; min-height:360px; border:none; border-radius:10px; background:#0f172a; }
    .live-caption { margin-top:6px; font-size:12px; color:#66758f; }
    @media (max-width: 1080px) { .method-builder { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 id="page-title">Создание записи</h1>
      <span class="pill" id="model-pill"></span>
    </div>

    <div class="card">
      <label id="token-label">Access token</label>
      <input id="token" placeholder="Вставьте access token..." />

      <form id="create-form"></form>

      <div class="actions" id="actions">
        <button id="submit-btn" class="btn" type="button">Сохранить</button>
        <a id="back-btn" class="btn secondary" href="{{ console_root|default:'/console/' }}">← Назад в консоль</a>
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const model = '{{ model }}';
    const modelNames = {
      groups: 'Группы',
      parents: 'Родители',
      students: 'Ученики',
      teachers: 'Преподаватели',
      subjects: 'Предметы',
      methods: 'Методпакеты',
      methodists: 'Методисты',
      managers: 'Менеджеры',
      assignments: 'Назначения',
      schedule: 'Расписание',
      holidays: 'Праздники',
      events: 'События',
      feed: 'Лента',
    };
    const apiModelMap = {
      groups: 'groups',
      parents: 'parents',
      students: 'students',
      teachers: 'teachers',
      subjects: 'subjects',
      methods: 'method-packages',
      methodists: 'profiles',
      managers: 'profiles',
      assignments: 'method-assignments',
      schedule: 'schedule',
      holidays: 'holidays',
      events: 'events',
      feed: 'feed-posts',
    };

    const tokenInput = document.getElementById('token');
    const form = document.getElementById('create-form');
    const statusBox = document.getElementById('status');
    const modelPill = document.getElementById('model-pill');
    const pageTitle = document.getElementById('page-title');
    const submitBtn = document.getElementById('submit-btn');
    const params = new URLSearchParams(window.location.search);
    const editId = params.get('id');
    const isEdit = Boolean(editId);
    const isEmbedded = params.get('embedded') === '1';
    const DEFAULT_CONSOLE_ROOT = '{{ console_root|default:"/console/" }}';
    const returnView = params.get('return_view') || '';
    const returnToRaw = params.get('return_to') || '';
    const safeReturnTo = (returnToRaw && returnToRaw.startsWith('/')) ? returnToRaw : DEFAULT_CONSOLE_ROOT;
    let currentItem = null;
    let methodBlocks = [];

    modelPill.textContent = modelNames[model] || model;
    pageTitle.textContent = isEdit ? 'Редактирование записи' : 'Создание записи';
    submitBtn.textContent = isEdit ? 'Сохранить изменения' : 'Сохранить';

    const tokenFromStorage = localStorage.getItem('consoleAccessToken') || '';
    if (tokenFromStorage) tokenInput.value = tokenFromStorage;
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
      backBtn.href = safeReturnTo;
      if (returnView === 'development') backBtn.textContent = 'Назад в кабинет преподавателя';
    }
    if (isEmbedded) {
      document.body.classList.add('embedded');
      const tokenLabel = document.getElementById('token-label');
      if (tokenLabel) tokenLabel.style.display = 'none';
      tokenInput.style.display = 'none';
      if (backBtn) backBtn.style.display = 'none';
    }

    tokenInput.addEventListener('input', () => {
      localStorage.setItem('consoleAccessToken', tokenInput.value.trim());
    });

    const refs = {
      groups: [],
      subjects: [],
      parents: [],
      teachers: [],
      methods: [],
      assignments: [],
      holidays: [],
    };

    function getMethodNumbersBySubject(subjectId) {
      const sid = Number(subjectId || 0);
      if (!sid) return [];
      return Array.from(new Set(refs.methods
        .filter((m) => Number(m.subject || 0) === sid)
        .map((m) => Number(m.method_number || 0))
        .filter((n) => Number.isFinite(n) && n > 0)
        .sort((a, b) => a - b)));
    }

    function renderScheduleMethodHints() {
      const subjectSel = document.getElementById('schedule-subject');
      const startInput = form.querySelector('[name="start_method_number"]');
      const hintAll = document.getElementById('schedule-method-numbers-hint');
      const hintStart = document.getElementById('schedule-start-method-hint');
      if (!subjectSel || !startInput || !hintAll || !hintStart) return;
      const numbers = getMethodNumbersBySubject(subjectSel.value);
      if (!numbers.length) {
        hintAll.textContent = 'Для предмета пока нет методпакетов. Сначала создайте методпакеты с номерами.';
        hintStart.textContent = 'Стартовый номер недоступен.';
        return;
      }
      hintAll.textContent = `Доступные номера методпакетов: ${numbers.join(', ')}`;
      const startVal = Number(startInput.value || 0);
      hintStart.textContent = numbers.includes(startVal)
        ? `Старт с методпакета №${startVal}. Далее автоматически: 2 занятия в неделю -> 2 методпакета в неделю по порядку.`
        : `Номер ${startVal || '—'} не найден у выбранного предмета. Выберите один из: ${numbers.join(', ')}.`;
    }

    function setStatus(text) { statusBox.textContent = text; }

    function getCsrfToken() {
      const m = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : '';
    }

    async function api(path, method = 'GET', body = null) {
      const token = tokenInput.value.trim();
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers.Authorization = 'Bearer ' + token;
      if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
        const csrf = getCsrfToken();
        if (csrf) headers['X-CSRFToken'] = csrf;
      }
      const res = await fetch(path, { method, headers, body: body ? JSON.stringify(body) : null });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || res.statusText);
      }
      if (res.status === 204) return null;
      return res.json();
    }

    async function uploadMedia(file) {
      const token = tokenInput.value.trim();
      const fd = new FormData();
      fd.append('file', file);
      const headers = {};
      if (token) headers.Authorization = 'Bearer ' + token;
      const csrf = getCsrfToken();
      if (csrf) headers['X-CSRFToken'] = csrf;
      const res = await fetch('/api/upload/', {
        method: 'POST',
        headers,
        body: fd,
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || 'Ошибка загрузки файла');
      }
      const data = await res.json();
      const rawUrl = data.url || '';
      if (!rawUrl) return '';
      // URLField в API требует валидный абсолютный URL.
      return rawUrl.startsWith('http') ? rawUrl : `${window.location.origin}${rawUrl}`;
    }

    function toAbsoluteUrl(url) {
      if (!url) return '';
      const value = String(url).trim();
      if (!value) return '';
      return value.startsWith('http') ? value : `${window.location.origin}${value}`;
    }

    function renderSelectOptions(id, items, labelFn) {
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = sel.multiple ? '' : '<option value="">Выберите</option>';
      items.forEach((item) => {
        const o = document.createElement('option');
        o.value = item.id;
        o.textContent = labelFn(item);
        sel.appendChild(o);
      });
    }

    function setField(name, value) {
      const field = form.querySelector(`[name="${name}"]`);
      if (!field) return;
      if (field.multiple && Array.isArray(value)) {
        Array.from(field.options).forEach((o) => {
          o.selected = value.includes(Number(o.value));
        });
        return;
      }
      field.value = value ?? '';
    }

    function toEmbedUrl(url) {
      if (!url) return null;
      const clean = String(url).trim();
      if (clean.includes('youtube.com/watch?v=')) {
        const id = clean.split('v=')[1].split('&')[0];
        return `https://www.youtube.com/embed/${id}`;
      }
      if (clean.includes('youtu.be/')) {
        const id = clean.split('youtu.be/')[1].split('?')[0];
        return `https://www.youtube.com/embed/${id}`;
      }
      return null;
    }

    function normalizeMethodBlock(block) {
      const raw = block || {};
      const type = raw.type || 'text';
      const style = raw.style || {};
      const styleBase = {
        textColor: String(style.textColor || '#1d2433'),
        fontSize: Number(style.fontSize || (type === 'heading' ? 32 : 18)),
        textAlign: String(style.textAlign || 'left'),
        maxWidth: Number(style.maxWidth || 100),
        radius: Number(style.radius || 10),
        bgColor: String(style.bgColor || (type === 'quote' ? '#eaf0ff' : 'transparent')),
        captionColor: String(style.captionColor || '#66758f'),
        captionSize: Number(style.captionSize || 12),
      };

      if (type === 'heading') return { type: 'heading', text: String(raw.text || ''), style: styleBase };
      if (type === 'quote') return { type: 'quote', text: String(raw.text || ''), style: styleBase };
      if (type === 'image') return { type: 'image', url: String(raw.url || ''), caption: String(raw.caption || ''), style: styleBase };
      if (type === 'video') return { type: 'video', url: String(raw.url || ''), caption: String(raw.caption || ''), style: styleBase };
      return { type: 'text', text: String(raw.text || ''), style: styleBase };
    }

    function defaultBlock(type) {
      return normalizeMethodBlock({ type });
    }

    function addStyleControls(block, box, onChange) {
      const controls = document.createElement('div');
      controls.className = 'row';
      controls.style.marginTop = '8px';

      const color = document.createElement('input');
      color.type = 'color';
      color.value = block.style.textColor || '#1d2433';
      color.title = 'Цвет текста';
      color.oninput = () => { block.style.textColor = color.value; onChange(); };

      const size = document.createElement('input');
      size.type = 'number';
      size.min = '10';
      size.max = '72';
      size.value = String(block.style.fontSize || 18);
      size.placeholder = 'Размер текста';
      size.oninput = () => { block.style.fontSize = Number(size.value || 18); onChange(); };

      const align = document.createElement('select');
      align.innerHTML = '<option value="left">Слева</option><option value="center">По центру</option><option value="right">Справа</option>';
      align.value = block.style.textAlign || 'left';
      align.onchange = () => { block.style.textAlign = align.value; onChange(); };

      controls.appendChild(color);
      controls.appendChild(size);
      controls.appendChild(align);
      box.appendChild(controls);
    }

    function addMediaStyleControls(block, box, onChange) {
      const controls = document.createElement('div');
      controls.className = 'row';
      controls.style.marginTop = '8px';

      const width = document.createElement('input');
      width.type = 'number';
      width.min = '20';
      width.max = '100';
      width.value = String(block.style.maxWidth || 100);
      width.placeholder = 'Ширина %';
      width.oninput = () => { block.style.maxWidth = Number(width.value || 100); onChange(); };

      const radius = document.createElement('input');
      radius.type = 'number';
      radius.min = '0';
      radius.max = '40';
      radius.value = String(block.style.radius || 10);
      radius.placeholder = 'Скругление';
      radius.oninput = () => { block.style.radius = Number(radius.value || 10); onChange(); };

      const align = document.createElement('select');
      align.innerHTML = '<option value="left">Слева</option><option value="center">По центру</option><option value="right">Справа</option>';
      align.value = block.style.textAlign || 'left';
      align.onchange = () => { block.style.textAlign = align.value; onChange(); };

      controls.appendChild(width);
      controls.appendChild(radius);
      controls.appendChild(align);
      box.appendChild(controls);

      const capControls = document.createElement('div');
      capControls.className = 'row';
      capControls.style.marginTop = '8px';
      const capColor = document.createElement('input');
      capColor.type = 'color';
      capColor.value = block.style.captionColor || '#66758f';
      capColor.oninput = () => { block.style.captionColor = capColor.value; onChange(); };
      const capSize = document.createElement('input');
      capSize.type = 'number';
      capSize.min = '10';
      capSize.max = '24';
      capSize.value = String(block.style.captionSize || 12);
      capSize.oninput = () => { block.style.captionSize = Number(capSize.value || 12); onChange(); };
      capControls.appendChild(capColor);
      capControls.appendChild(capSize);
      box.appendChild(capControls);
    }

    function renderMethodLivePreview() {
      const live = document.getElementById('method-live-page');
      if (!live) return;
      const normalizedBlocks = methodBlocks.map((b) => normalizeMethodBlock(b));
      const titleInput = form.querySelector('[name="title"]');
      const descInput = form.querySelector('[name="description"]');
      const sourceInput = form.querySelector('[name="material_url"]');
      const title = titleInput ? titleInput.value.trim() : '';
      const description = descInput ? descInput.value.trim() : '';
      const source = sourceInput ? sourceInput.value.trim() : '';

      live.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'live-header';
      header.innerHTML = `<div class="live-badge">Методпакет</div><h2 class="live-title">${title || 'Название урока'}</h2>`;
      if (description) {
        const d = document.createElement('p');
        d.className = 'live-desc';
        d.textContent = description;
        header.appendChild(d);
      }
      if (source) {
        const a = document.createElement('a');
        a.className = 'live-material-link';
        a.href = source;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'Учебные материалы';
        header.appendChild(a);
      }
      live.appendChild(header);

      if (!normalizedBlocks.length) {
        const empty = document.createElement('div');
        empty.className = 'live-desc';
        empty.textContent = 'Добавьте блоки слева, чтобы собрать страницу урока.';
        live.appendChild(empty);
        return;
      }

      normalizedBlocks.forEach((block) => {
        const section = document.createElement('section');
        section.className = 'live-block';
        section.style.textAlign = block.style.textAlign || 'left';

        if (block.type === 'heading') {
          const h = document.createElement('h3');
          h.textContent = block.text || '';
          h.style.color = block.style.textColor;
          h.style.fontSize = `${block.style.fontSize}px`;
          section.appendChild(h);
        }
        if (block.type === 'text') {
          const p = document.createElement('p');
          p.textContent = block.text || '';
          p.style.color = block.style.textColor;
          p.style.fontSize = `${block.style.fontSize}px`;
          section.appendChild(p);
        }
        if (block.type === 'quote') {
          const q = document.createElement('div');
          q.className = 'live-quote';
          q.textContent = block.text || '';
          q.style.color = block.style.textColor;
          q.style.fontSize = `${block.style.fontSize}px`;
          q.style.background = block.style.bgColor || '#eaf0ff';
          section.appendChild(q);
        }
        if (block.type === 'image' && block.url) {
          const img = document.createElement('img');
          img.src = block.url;
          img.alt = block.caption || 'image';
          img.style.maxWidth = `${block.style.maxWidth}%`;
          img.style.borderRadius = `${block.style.radius}px`;
          if (block.style.textAlign === 'center') img.style.margin = '0 auto';
          if (block.style.textAlign === 'right') img.style.margin = '0 0 0 auto';
          section.appendChild(img);
          if (block.caption) {
            const cap = document.createElement('div');
            cap.className = 'live-caption';
            cap.textContent = block.caption;
            cap.style.color = block.style.captionColor;
            cap.style.fontSize = `${block.style.captionSize}px`;
            section.appendChild(cap);
          }
        }
        if (block.type === 'video' && block.url) {
          const embed = toEmbedUrl(block.url);
          if (embed) {
            const iframe = document.createElement('iframe');
            iframe.src = embed;
            iframe.allowFullscreen = true;
            iframe.style.maxWidth = `${block.style.maxWidth}%`;
            iframe.style.borderRadius = `${block.style.radius}px`;
            if (block.style.textAlign === 'center') iframe.style.margin = '0 auto';
            if (block.style.textAlign === 'right') iframe.style.margin = '0 0 0 auto';
            section.appendChild(iframe);
          } else {
            const video = document.createElement('video');
            video.src = block.url;
            video.controls = true;
            video.style.width = `${block.style.maxWidth}%`;
            video.style.borderRadius = `${block.style.radius}px`;
            if (block.style.textAlign === 'center') video.style.margin = '0 auto';
            if (block.style.textAlign === 'right') video.style.margin = '0 0 0 auto';
            section.appendChild(video);
          }
          if (block.caption) {
            const cap = document.createElement('div');
            cap.className = 'live-caption';
            cap.textContent = block.caption;
            cap.style.color = block.style.captionColor;
            cap.style.fontSize = `${block.style.captionSize}px`;
            section.appendChild(cap);
          }
        }
        live.appendChild(section);
      });
    }

    function renderMethodBlocksEditor() {
      const list = document.getElementById('method-blocks-list');
      if (!list) return;
      list.innerHTML = '';

      methodBlocks = methodBlocks.map((b) => normalizeMethodBlock(b));

      methodBlocks.forEach((block, idx) => {
        const box = document.createElement('div');
        box.className = 'block-item';
        const titleMap = { heading: 'Заголовок', text: 'Текст', quote: 'Цитата', image: 'Картинка', video: 'Видео' };
        box.innerHTML = `
          <div class="block-head">
            <div class="block-kind">Блок ${idx + 1}: ${titleMap[block.type] || block.type}</div>
            <div class="block-actions">
              <button type="button" class="btn secondary small" data-act="up" data-i="${idx}">Вверх</button>
              <button type="button" class="btn secondary small" data-act="down" data-i="${idx}">Вниз</button>
              <button type="button" class="btn secondary small" data-act="del" data-i="${idx}">Удалить</button>
            </div>
          </div>
        `;

        if (block.type === 'heading' || block.type === 'text' || block.type === 'quote') {
          const area = document.createElement('textarea');
          area.rows = block.type === 'heading' ? 2 : 4;
          area.placeholder = block.type === 'heading' ? 'Заголовок раздела' : (block.type === 'quote' ? 'Цитата/выделенный блок' : 'Текст блока');
          area.value = block.text || '';
          area.oninput = () => { methodBlocks[idx].text = area.value; renderMethodLivePreview(); };
          box.appendChild(area);
          addStyleControls(methodBlocks[idx], box, renderMethodLivePreview);
          if (block.type === 'quote') {
            const quoteBg = document.createElement('input');
            quoteBg.type = 'color';
            quoteBg.value = methodBlocks[idx].style.bgColor || '#eaf0ff';
            quoteBg.oninput = () => { methodBlocks[idx].style.bgColor = quoteBg.value; renderMethodLivePreview(); };
            box.appendChild(quoteBg);
          }
        } else {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = block.type === 'image' ? 'image/*' : 'video/*';
          fileInput.onchange = async () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            try {
              setStatus('Загрузка файла...');
              const url = await uploadMedia(file);
              methodBlocks[idx].url = url;
              renderMethodBlocksEditor();
              renderMethodLivePreview();
              setStatus('Файл загружен');
            } catch (e) {
              setStatus(e.message);
            }
          };
          const url = document.createElement('input');
          url.readOnly = true;
          url.placeholder = 'Файл не выбран';
          url.value = block.url || '';
          const cap = document.createElement('input');
          cap.placeholder = 'Подпись (необязательно)';
          cap.value = block.caption || '';
          cap.oninput = () => { methodBlocks[idx].caption = cap.value; renderMethodLivePreview(); };
          box.appendChild(fileInput);
          box.appendChild(url);
          box.appendChild(cap);
          addMediaStyleControls(methodBlocks[idx], box, renderMethodLivePreview);
        }
        list.appendChild(box);
      });

      list.querySelectorAll('button[data-act]').forEach((btn) => {
        btn.onclick = () => {
          const i = Number(btn.dataset.i);
          const act = btn.dataset.act;
          if (act === 'del') methodBlocks.splice(i, 1);
          if (act === 'up' && i > 0) [methodBlocks[i - 1], methodBlocks[i]] = [methodBlocks[i], methodBlocks[i - 1]];
          if (act === 'down' && i < methodBlocks.length - 1) [methodBlocks[i + 1], methodBlocks[i]] = [methodBlocks[i], methodBlocks[i + 1]];
          renderMethodBlocksEditor();
          renderMethodLivePreview();
        };
      });

      renderMethodLivePreview();
    }

    function renderForm() {
      if (model === 'groups') {
        form.innerHTML = `
          <label>Название</label><input name="name" required />
          <label>Описание</label><textarea name="description" rows="2"></textarea>
        `;
        return;
      }
      if (model === 'parents') {
        form.innerHTML = `
          <div class="row"><input name="last_name" placeholder="Фамилия" required /><input name="first_name" placeholder="Имя" required /></div>
          <label>Телефон</label><input name="phone" placeholder="+7 900 000-00-00" />
          <label>Email</label><input name="email" type="email" placeholder="parent@example.com" />
        `;
        return;
      }
      if (model === 'students') {
        form.innerHTML = `
          <div class="row"><input name="last_name" placeholder="Фамилия" required /><input name="first_name" placeholder="Имя" required /></div>
          <label>Группа</label><select id="student-group" name="group" required></select>
          <label>Родители</label><select id="student-parents" name="parents" multiple size="4" style="height:auto;"></select>
          <label>Заметки</label><textarea name="notes" rows="2"></textarea>
        `;
        renderSelectOptions('student-group', refs.groups, (g) => g.name);
        renderSelectOptions('student-parents', refs.parents, (p) => `${p.last_name} ${p.first_name}`);
        return;
      }
      if (model === 'teachers') {
        form.innerHTML = `
          <div class="row"><input name="last_name" placeholder="Фамилия" required /><input name="first_name" placeholder="Имя" required /></div>
          <label>Телефон</label><input name="phone" placeholder="+7 900 000-00-00" />
          <label>Email</label><input name="email" type="email" placeholder="teacher@example.com" />
          <label>Группы</label><select id="teacher-groups" name="groups" multiple size="4" style="height:auto;"></select>
        `;
        renderSelectOptions('teacher-groups', refs.groups, (g) => g.name);
        return;
      }
      if (model === 'methodists' || model === 'managers') {
        const roleLabel = model === 'managers' ? 'manager' : 'methodist';
        const placeholderEmail = model === 'managers' ? 'manager@example.com' : 'methodist@example.com';
        form.innerHTML = `
          <label>Логин</label><input name="username" required />
          <label>Email</label><input name="email" type="email" placeholder="${placeholderEmail}" />
          <label>Пароль ${isEdit ? '(оставьте пустым, чтобы не менять)' : ''}</label><input name="password" type="password" ${isEdit ? '' : 'required'} />
          <div class="hint">Роль назначается автоматически: ${roleLabel}.</div>
        `;
        return;
      }
      if (model === 'subjects') {
        form.innerHTML = `
          <label>Название предмета</label><input name="name" required />
        `;
        return;
      }
      if (model === 'methods') {
        form.innerHTML = `
          <label>Предмет</label><select id="method-subject" name="subject" required></select>
          <label>Номер методпакета (1-12)</label><input name="method_number" type="number" min="1" max="12" required />
          <label>Название</label><input name="title" required />
          <label>Описание</label><textarea name="description" rows="2"></textarea>
          <label>Ссылка на материалы</label><input name="material_url" type="url" placeholder="https://..." />
          <div class="method-builder">
            <div class="builder-pane">
              <h4 class="builder-title">Конструктор блоков</h4>
              <div class="blocks-toolbar">
                <button type="button" class="btn secondary small" id="add-heading-block">+ Заголовок</button>
                <button type="button" class="btn secondary small" id="add-text-block">+ Текст</button>
                <button type="button" class="btn secondary small" id="add-quote-block">+ Цитата</button>
                <button type="button" class="btn secondary small" id="add-image-block">+ Картинка</button>
                <button type="button" class="btn secondary small" id="add-video-block">+ Видео</button>
              </div>
              <div id="method-blocks-list" class="block-list"></div>
            </div>
            <div class="preview-pane">
              <h4 class="preview-title">Так страницу увидит студент</h4>
              <div id="method-live-page" class="live-page"></div>
            </div>
          </div>
        `;
        const methodSubject = document.getElementById('method-subject');
        methodSubject.innerHTML = '<option value="">Выберите предмет</option>';
        refs.subjects.forEach((s) => {
          const o = document.createElement('option');
          o.value = s.id;
          o.textContent = s.name;
          methodSubject.appendChild(o);
        });
        const sync = () => renderMethodLivePreview();
        form.querySelector('[name="title"]').addEventListener('input', sync);
        form.querySelector('[name="description"]').addEventListener('input', sync);
        form.querySelector('[name="material_url"]').addEventListener('input', sync);
        document.getElementById('add-heading-block').onclick = () => { methodBlocks.push(defaultBlock('heading')); renderMethodBlocksEditor(); };
        document.getElementById('add-text-block').onclick = () => { methodBlocks.push(defaultBlock('text')); renderMethodBlocksEditor(); };
        document.getElementById('add-quote-block').onclick = () => { methodBlocks.push(defaultBlock('quote')); renderMethodBlocksEditor(); };
        document.getElementById('add-image-block').onclick = () => { methodBlocks.push(defaultBlock('image')); renderMethodBlocksEditor(); };
        document.getElementById('add-video-block').onclick = () => { methodBlocks.push(defaultBlock('video')); renderMethodBlocksEditor(); };
        renderMethodBlocksEditor();
        return;
      }
      if (model === 'schedule') {
        form.innerHTML = `
          <label>Группа</label><select id="schedule-group" name="group" required></select>
          <label>Предмет</label><select id="schedule-subject" name="subject_id" required></select>
          <label>Стартовый номер методпакета</label><input name="start_method_number" type="number" min="1" max="12" value="1" required />
          <div id="schedule-method-numbers-hint" class="hint"></div>
          <div id="schedule-start-method-hint" class="hint"></div>
          <label>Дата первого занятия</label><input name="lesson_date" type="date" required />
          <label>Номер первого занятия</label><input name="lesson_number" type="number" min="1" max="999" value="1" required />
          ${isEdit ? '<label>Переназначить методпакеты начиная с занятия №</label><input name="apply_from_lesson_number" type="number" min="1" placeholder="например, 3" />' : ''}
          <label>Начало (HH:MM)</label><input name="start_time" type="time" required />
          <div class="quick-time-list">
            <label class="quick-time-item"><input class="schedule-time-preset" type="checkbox" value="10:00" />10:00</label>
            <label class="quick-time-item"><input class="schedule-time-preset" type="checkbox" value="13:00" />13:00</label>
            <label class="quick-time-item"><input class="schedule-time-preset" type="checkbox" value="16:00" />16:00</label>
            <label class="quick-time-item"><input class="schedule-time-preset" type="checkbox" value="16:30" />16:30</label>
          </div>
          <div class="hint">Можно выбрать время чекбоксом или ввести вручную.</div>
          <input name="occurrences_count" type="hidden" value="6" />
          <div class="hint">Автоматически создаются 2 занятия в неделю на 6 недель (всего 12) и к ним цепляются методпакеты последовательно по номеру.</div>
          <div class="hint">При редактировании можно переназначить цепочку методпакетов, начиная с нужного номера занятия.</div>
        `;
        renderSelectOptions('schedule-group', refs.groups, (g) => g.name);
        const subjectSel = document.getElementById('schedule-subject');
        subjectSel.innerHTML = '<option value="">Выберите предмет</option>';
        refs.subjects.forEach((m) => {
          const o = document.createElement('option');
          o.value = m.id;
          o.textContent = m.name;
          subjectSel.appendChild(o);
        });
        const startMethodInput = form.querySelector('[name="start_method_number"]');
        subjectSel.addEventListener('change', renderScheduleMethodHints);
        startMethodInput.addEventListener('input', renderScheduleMethodHints);
        const timeInput = form.querySelector('[name="start_time"]');
        const presets = Array.from(form.querySelectorAll('.schedule-time-preset'));
        const syncFromInput = () => {
          const raw = String(timeInput.value || '');
          const value = raw.length >= 5 ? raw.slice(0, 5) : raw;
          presets.forEach((p) => { p.checked = p.value === value; });
        };
        presets.forEach((preset) => {
          preset.addEventListener('change', () => {
            if (preset.checked) {
              presets.forEach((p) => { if (p !== preset) p.checked = false; });
              timeInput.value = preset.value;
            } else if ((timeInput.value || '').slice(0, 5) === preset.value) {
              timeInput.value = '';
            }
          });
        });
        timeInput.addEventListener('input', syncFromInput);
        syncFromInput();
        renderScheduleMethodHints();
        return;
      }
      if (model === 'holidays') {
        form.innerHTML = `
          <label>Дата праздника</label><input name="date" type="date" required />
          <label>Название</label><input name="title" placeholder="Праздничный день" />
          <label>Группа (необязательно)</label><select id="holiday-group" name="group"></select>
          <div class="hint">Если группа не выбрана, перенос применяется ко всем группам.</div>
        `;
        const sel = document.getElementById('holiday-group');
        sel.innerHTML = '<option value="">Все группы</option>';
        refs.groups.forEach((g) => {
          const o = document.createElement('option');
          o.value = g.id;
          o.textContent = g.name;
          sel.appendChild(o);
        });
        return;
      }
      if (model === 'assignments') {
        form.innerHTML = `
          <label>Методпакет</label><select id="assignment-method" name="method_package" required></select>
          <label>Преподаватель</label><select id="assignment-teacher" name="teacher" required></select>
          <label>Дедлайн</label><input name="deadline" type="date" />
          <label>Можно редактировать</label>
          <select name="can_edit">
            <option value="true">Да</option>
            <option value="false">Нет</option>
          </select>
          <label>Статус</label>
          <select name="status">
            <option value="todo">К выполнению</option>
            <option value="in_progress">В работе</option>
            <option value="review">На проверке</option>
            <option value="done">Готово</option>
          </select>
          <label>Заметки</label><textarea name="notes" rows="3"></textarea>
        `;
        renderSelectOptions('assignment-method', refs.methods, (m) => m.title);
        renderSelectOptions('assignment-teacher', refs.teachers, (t) => `${t.last_name} ${t.first_name}`);
        return;
      }
      if (model === 'events') {
        form.innerHTML = `
          <label>Группа</label><select id="event-group" name="group" required></select>
          <label>Заголовок</label><input name="title" required />
          <label>Описание</label><textarea name="description" rows="3"></textarea>
          <label>Дата события</label><input name="event_date" type="date" />
          <label>Тип медиа</label>
          <select name="media_type">
            <option value="none">Без медиа</option>
            <option value="image">Изображение</option>
            <option value="video">Видео</option>
          </select>
          <label>Файл медиа</label><input id="event-media-file" type="file" accept="image/*,video/*" />
          <label>Загруженный файл</label><input id="event-media-url" readonly placeholder="Файл не выбран" />
          <div class="hint">Загрузите фото/видео с компьютера.</div>
        `;
        renderSelectOptions('event-group', refs.groups, (g) => g.name);
        const fileInput = document.getElementById('event-media-file');
        const urlInput = document.getElementById('event-media-url');
        fileInput.onchange = async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          try {
            setStatus('Загрузка файла...');
            const url = await uploadMedia(file);
            urlInput.value = url;
            setStatus('Файл загружен');
          } catch (e) {
            setStatus(e.message);
          }
        };
        return;
      }
      if (model === 'feed') {
        form.innerHTML = `
          <label>Группа</label><select id="feed-group" name="group" required></select>
          <label>Автор</label><input name="author_name" required />
          <label>Текст поста</label><textarea name="text" rows="4" required></textarea>
          <label>Тип медиа</label>
          <select name="media_type">
            <option value="none">Без медиа</option>
            <option value="image">Изображение</option>
            <option value="video">Видео</option>
          </select>
          <label>Файл медиа</label><input id="feed-media-file" type="file" accept="image/*,video/*" />
          <label>Загруженный файл</label><input id="feed-media-url" readonly placeholder="Файл не выбран" />
          <div class="hint">Загрузите фото/видео с компьютера.</div>
        `;
        renderSelectOptions('feed-group', refs.groups, (g) => g.name);
        const fileInput = document.getElementById('feed-media-file');
        const urlInput = document.getElementById('feed-media-url');
        fileInput.onchange = async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          try {
            setStatus('Загрузка файла...');
            const url = await uploadMedia(file);
            urlInput.value = url;
            setStatus('Файл загружен');
          } catch (e) {
            setStatus(e.message);
          }
        };
      }
    }

    function applyCurrentItem() {
      if (!currentItem) return;
      if (model === 'groups') {
        setField('name', currentItem.name);
        setField('description', currentItem.description);
        return;
      }
      if (model === 'parents') {
        setField('last_name', currentItem.last_name);
        setField('first_name', currentItem.first_name);
        setField('phone', currentItem.phone);
        setField('email', currentItem.email);
        return;
      }
      if (model === 'students') {
        setField('last_name', currentItem.last_name);
        setField('first_name', currentItem.first_name);
        setField('group', currentItem.group);
        setField('parents', currentItem.parents || []);
        setField('notes', currentItem.notes);
        return;
      }
      if (model === 'teachers') {
        setField('last_name', currentItem.last_name);
        setField('first_name', currentItem.first_name);
        setField('phone', currentItem.phone);
        setField('email', currentItem.email);
        setField('groups', currentItem.groups || []);
        return;
      }
      if (model === 'methodists' || model === 'managers') {
        setField('username', currentItem.username);
        setField('email', currentItem.email);
        return;
      }
      if (model === 'subjects') {
        setField('name', currentItem.name);
        return;
      }
      if (model === 'methods') {
        setField('subject', currentItem.subject || '');
        setField('method_number', currentItem.method_number || 1);
        setField('title', currentItem.title);
        setField('description', currentItem.description);
        setField('material_url', currentItem.material_url);
        methodBlocks = Array.isArray(currentItem.content_blocks) ? currentItem.content_blocks : [];
        renderMethodBlocksEditor();
        return;
      }
      if (model === 'schedule') {
        setField('group', currentItem.group);
        setField('lesson_date', currentItem.lesson_date);
        setField('lesson_number', currentItem.lesson_number);
        setField('start_time', currentItem.start_time);
        setField('duration_minutes', currentItem.duration_minutes);
        if (currentItem.method_package && currentItem.method_package.subject) {
          setField('subject_id', currentItem.method_package.subject);
          setField('start_method_number', currentItem.method_package.method_number || 1);
        }
        renderScheduleMethodHints();
        return;
      }
      if (model === 'holidays') {
        setField('date', currentItem.date);
        setField('title', currentItem.title);
        setField('group', currentItem.group || '');
        return;
      }
      if (model === 'assignments') {
        setField('method_package', currentItem.method_package);
        setField('teacher', currentItem.teacher);
        setField('deadline', currentItem.deadline);
        setField('can_edit', String(Boolean(currentItem.can_edit)));
        setField('status', currentItem.status || 'todo');
        setField('notes', currentItem.notes || '');
        return;
      }
      if (model === 'events') {
        setField('group', currentItem.group);
        setField('title', currentItem.title);
        setField('description', currentItem.description);
        setField('event_date', currentItem.event_date);
        setField('media_type', currentItem.media_type || 'none');
        const mediaField = document.getElementById('event-media-url');
        if (mediaField) mediaField.value = currentItem.media_url || '';
        return;
      }
      if (model === 'feed') {
        setField('group', currentItem.group);
        setField('author_name', currentItem.author_name);
        setField('text', currentItem.text);
        setField('media_type', currentItem.media_type || 'none');
        const mediaField = document.getElementById('feed-media-url');
        if (mediaField) mediaField.value = currentItem.media_url || '';
      }
    }

    async function loadRefsIfNeeded() {
      const needGroups = model === 'students' || model === 'teachers' || model === 'schedule' || model === 'holidays' || model === 'events' || model === 'feed';
      const needSubjects = model === 'methods' || model === 'schedule';
      const needParents = model === 'students';
      const needMethods = model === 'schedule' || model === 'assignments' || model === 'methods';
      const needTeachers = model === 'assignments';
      const tasks = [];
      if (needGroups) tasks.push(api('/api/groups/').then((d) => { refs.groups = d; }));
      if (needSubjects) tasks.push(api('/api/subjects/').then((d) => { refs.subjects = d; }));
      if (needParents) tasks.push(api('/api/parents/').then((d) => { refs.parents = d; }));
      if (needMethods) tasks.push(api('/api/method-packages/').then((d) => { refs.methods = d; }));
      if (needTeachers) tasks.push(api('/api/teachers/').then((d) => { refs.teachers = d; }));
      await Promise.all(tasks);
    }

    async function refreshFormData() {
      currentItem = null;
      if (model === 'methods') methodBlocks = [];
      try {
        await loadRefsIfNeeded();
        if (isEdit) {
          currentItem = await api(`/api/${apiModelMap[model]}/${editId}/`);
        }
      } catch (e) {
        setStatus(e.message);
      }
      renderForm();
      applyCurrentItem();
    }

    async function collectData() {
      const data = Object.fromEntries(new FormData(form).entries());
      if (model === 'students') {
        data.group = Number(data.group);
        const parentSel = document.getElementById('student-parents');
        data.parents = Array.from(parentSel.selectedOptions).map((o) => Number(o.value));
      }
      if (model === 'teachers') {
        const groupSel = document.getElementById('teacher-groups');
        data.groups = Array.from(groupSel.selectedOptions).map((o) => Number(o.value));
      }
      if (model === 'methods') {
        data.subject = Number(data.subject);
        data.method_number = Number(data.method_number);
      }
      if (model === 'methodists' || model === 'managers') {
        data.role = model === 'managers' ? 'manager' : 'methodist';
        if (!data.password) delete data.password;
      }
      if (model === 'schedule') {
        data.group = Number(data.group);
        data.subject_id = Number(data.subject_id);
        data.start_method_number = Number(data.start_method_number || 1);
        data.lesson_number = Number(data.lesson_number || 1);
        data.occurrences_count = isEdit ? 1 : Number(data.occurrences_count || 6);
        const available = getMethodNumbersBySubject(data.subject_id);
        if (!available.length) {
          throw new Error('Для выбранного предмета нет методпакетов. Сначала создайте их.');
        }
        if (!available.includes(data.start_method_number)) {
          throw new Error(`Номер ${data.start_method_number} не найден у выбранного предмета. Доступно: ${available.join(', ')}`);
        }
        if (!data.apply_from_lesson_number) delete data.apply_from_lesson_number;
        else data.apply_from_lesson_number = Number(data.apply_from_lesson_number);
      }
      if (model === 'holidays') {
        data.group = data.group ? Number(data.group) : null;
        if (!data.title) data.title = 'Праздничный день';
      }
      if (model === 'assignments') {
        data.method_package = Number(data.method_package);
        data.teacher = Number(data.teacher);
        data.can_edit = String(data.can_edit) === 'true';
      }
      if (model === 'events') {
        data.group = Number(data.group);
        data.media_type = data.media_type || 'none';
        const fileInput = document.getElementById('event-media-file');
        const urlInput = document.getElementById('event-media-url');
        if (data.media_type === 'none') {
          data.media_url = '';
        } else if (urlInput && urlInput.value) {
          data.media_url = toAbsoluteUrl(urlInput.value);
        } else if (fileInput && fileInput.files && fileInput.files[0]) {
          setStatus('Загрузка файла...');
          data.media_url = await uploadMedia(fileInput.files[0]);
        } else {
          data.media_url = (urlInput && urlInput.value) ? toAbsoluteUrl(urlInput.value) : '';
        }
      }
      if (model === 'feed') {
        data.group = Number(data.group);
        data.media_type = data.media_type || 'none';
        const fileInput = document.getElementById('feed-media-file');
        const urlInput = document.getElementById('feed-media-url');
        if (data.media_type === 'none') {
          data.media_url = '';
        } else if (urlInput && urlInput.value) {
          data.media_url = toAbsoluteUrl(urlInput.value);
        } else if (fileInput && fileInput.files && fileInput.files[0]) {
          setStatus('Загрузка файла...');
          data.media_url = await uploadMedia(fileInput.files[0]);
        } else {
          data.media_url = (urlInput && urlInput.value) ? toAbsoluteUrl(urlInput.value) : '';
        }
      }
      if (model === 'methods') {
        data.content_blocks = methodBlocks
          .map((raw) => {
            const b = normalizeMethodBlock(raw);
            const style = {
              textColor: String(b.style.textColor || ''),
              fontSize: Number(b.style.fontSize || 0),
              textAlign: String(b.style.textAlign || ''),
              maxWidth: Number(b.style.maxWidth || 0),
              radius: Number(b.style.radius || 0),
              bgColor: String(b.style.bgColor || ''),
              captionColor: String(b.style.captionColor || ''),
              captionSize: Number(b.style.captionSize || 0),
            };
            if (b.type === 'heading') return { type: 'heading', text: String(b.text || '').trim(), style };
            if (b.type === 'quote') return { type: 'quote', text: String(b.text || '').trim(), style };
            if (b.type === 'text') return { type: 'text', text: String(b.text || '').trim(), style };
            if (b.type === 'image') return { type: 'image', url: String(b.url || '').trim(), caption: String(b.caption || '').trim(), style };
            return { type: 'video', url: String(b.url || '').trim(), caption: String(b.caption || '').trim(), style };
          })
          .filter((b) => ((b.type === 'text' || b.type === 'heading' || b.type === 'quote') && b.text) || ((b.type === 'image' || b.type === 'video') && b.url));
      }
      return data;
    }

    submitBtn.onclick = async () => {
      if (!form.reportValidity()) return;
      try {
        setStatus(isEdit ? 'Сохранение изменений...' : 'Сохранение...');
        const data = await collectData();
        const path = isEdit ? `/api/${apiModelMap[model]}/${editId}/` : `/api/${apiModelMap[model]}/`;
        const method = isEdit ? 'PUT' : 'POST';
        const saved = await api(path, method, data);
        if (isEmbedded && window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'consoleCreateSaved',
            model,
            id: (saved && saved.id) ? saved.id : (editId ? Number(editId) : null),
            mode: isEdit ? 'update' : 'create',
          }, window.location.origin);
        }
        const target = safeReturnTo || DEFAULT_CONSOLE_ROOT;
        if (isEmbedded) {
          setStatus(isEdit ? 'Обновлено.' : 'Создано.');
          return;
        }
        setStatus(isEdit ? 'Обновлено. Возвращаю обратно...' : 'Создано. Возвращаю обратно...');
        setTimeout(() => { window.location.href = target; }, 500);
      } catch (e) {
        setStatus(e.message);
      }
    };

    tokenInput.addEventListener('blur', refreshFormData);

    (async () => {
      await refreshFormData();
    })();
  </script>
</body>
</html>
