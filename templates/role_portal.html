<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ portal_title }}</title>
  <style>
    :root {
      --bg: #0b1021;
      --panel: #0f162e;
      --panel-soft: #111a35;
      --panel-2: #0d142a;
      --border: rgba(255, 255, 255, 0.08);
      --text: #f7f7f7;
      --muted: #c4c7d4;
      --primary: #0b9fd4;
      --primary-2: #19d1ff;
      --bubble-self: #0d2547;
      --bubble-other: #141e38;
      --accent-cyan: #19d1ff;
      --accent-red: #ff6b6b;
      --ok: #36c98f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 24px;
      color: var(--text);
      font-family: 'Inter', 'JetBrains Mono', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 14% 15%, rgba(25, 209, 255, 0.08), transparent 26%),
        radial-gradient(circle at 86% 14%, rgba(255, 107, 107, 0.08), transparent 28%),
        var(--bg);
    }

    .wrap { max-width: 1580px; margin: 0 auto; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 2.4vw, 30px);
      letter-spacing: -0.02em;
      font-weight: 800;
      color: var(--text);
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .who {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      letter-spacing: 0.01em;
    }

    .logout {
      border: 1px solid rgba(255,80,80,0.25);
      background: rgba(255,59,48,0.08);
      color: rgba(255,100,100,0.8);
      border-radius: 10px;
      padding: 7px 14px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .logout:hover { background: rgba(255,59,48,0.16); color: #ff6060; }

    .bell-btn {
      position: relative;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }

    .bell-count {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 18px;
      height: 18px;
      padding: 0 4px;
      border-radius: 999px;
      background: #ff4d5b;
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255,255,255,.3);
    }

    .classes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .portal-tabs {
      display: none;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: flex-start;
    }
    .portal-layout { display: block; }
    .portal-content { min-width: 0; }
    .portal-tab-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background .15s, color .15s, border-color .15s;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .portal-tab-btn:hover:not(.active) { background: rgba(255,255,255,.05); color: var(--text); }
    .portal-tab-btn.active {
      background: rgba(25,209,255,0.12);
      border-color: rgba(25,209,255,0.22);
      color: #19d1ff;
      box-shadow: none;
    }
    .portal-layout.teacher-layout {
      display: grid;
      grid-template-columns: 240px minmax(0, 1fr);
      gap: 18px;
      align-items: start;
    }
    .portal-layout.teacher-layout .portal-tabs {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 4px;
      margin: 0;
      position: sticky;
      top: 12px;
      background: rgba(255,255,255,.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
    }
    .portal-nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      padding: 4px 10px 8px;
      opacity: 0.6;
    }
    .portal-layout.teacher-layout .portal-tab-btn {
      width: 100%;
      text-align: left;
      padding: 11px 14px;
      font-size: 14px;
      border-radius: 12px;
    }
    .content-pane { display: none; }
    .content-pane.active { display: block; }
    .manager-link-btn {
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 14px;
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: background .15s, border-color .15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .manager-link-btn:hover { background: rgba(255,255,255,.1); border-color: rgba(255,255,255,.2); }
    .manager-link-btn.primary {
      background: linear-gradient(120deg, #19d1ff, #38e8ff);
      border-color: rgba(25,209,255,.3);
      color: #0b1021;
      font-weight: 700;
      box-shadow: 0 4px 14px rgba(25,209,255,.2);
    }
    .manager-link-btn.primary:hover { box-shadow: 0 6px 20px rgba(25,209,255,.3); }
    .manager-link-btn.danger {
      border-color: rgba(255,80,80,.2);
      background: rgba(255,59,48,.08);
      color: rgba(255,100,100,.85);
    }
    .manager-link-btn.danger:hover { background: rgba(255,59,48,.14); border-color: rgba(255,80,80,.3); color: #ff6060; }
    .manager-inline-status { color: var(--muted); font-size: 12px; margin: 4px 0 16px; line-height: 1.5; }
    .manager-admin-layout {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      gap: 12px;
      margin-top: 8px;
    }
    .manager-admin-nav {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 8px;
      display: grid;
      gap: 4px;
      align-content: start;
      height: fit-content;
      position: sticky;
      top: 12px;
    }
    .manager-admin-nav-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      text-align: left;
      transition: background .15s, color .15s, border-color .15s;
    }
    .manager-admin-nav-btn:hover:not(.active) { background: rgba(255,255,255,.05); color: var(--text); }
    .manager-admin-nav-btn.active {
      background: rgba(25,209,255,0.1);
      border-color: rgba(25,209,255,0.2);
      color: #19d1ff;
    }
    .manager-admin-main { min-width: 0; }
    .manager-admin-toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .manager-admin-toolbar input,
    .manager-admin-toolbar select {
      margin: 0;
    }
    .manager-admin-grid {
      display: grid;
      grid-template-columns: 380px minmax(0, 1fr);
      gap: 12px;
    }
    .manager-admin-list {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 10px;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .manager-admin-list-items {
      display: grid;
      gap: 8px;
      max-height: 560px;
      overflow: auto;
      padding-right: 4px;
    }
    .manager-admin-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      padding: 10px;
      cursor: pointer;
    }
    .manager-admin-item.active {
      border-color: rgba(25,209,255,.35);
      box-shadow: inset 0 0 0 1px rgba(25,209,255,.1);
      background: rgba(25,209,255,.06);
    }
    .manager-admin-item:hover:not(.active) { border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.05); }
    .manager-admin-item-title { font-weight: 700; font-size: 14px; }
    .manager-admin-item-meta { color: var(--muted); font-size: 12px; margin-top: 3px; line-height: 1.35; }
    .manager-admin-form {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 20px;
      min-height: 420px;
      position: relative;
      overflow: hidden;
    }
    .manager-admin-form::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, rgba(25,209,255,0.5) 0%, transparent 100%);
      border-radius: 14px 14px 0 0;
    }
    .manager-admin-form-embed {
      width: 100%;
      min-height: 760px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.01);
    }
    .manager-admin-form-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .manager-admin-form h4 { margin: 0; font-size: 16px; font-weight: 800; }
    .manager-card-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .manager-admin-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .manager-admin-form label,
    .manager-social-grid label {
      display: block;
      margin: 14px 0 5px;
      color: var(--muted);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .manager-admin-form-grid.full > * { grid-column: 1 / -1; }
    .manager-admin-form .full { grid-column: 1 / -1; }
    .manager-admin-form input,
    .manager-admin-form select,
    .manager-admin-form textarea,
    .manager-admin-toolbar input,
    .manager-admin-toolbar select {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-family: inherit;
      font-size: 13px;
      transition: border .2s, box-shadow .2s;
    }
    .manager-admin-form input:focus,
    .manager-admin-form select:focus,
    .manager-admin-form textarea:focus,
    .manager-admin-toolbar input:focus,
    .manager-admin-toolbar select:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(25,209,255,.1);
    }
    .manager-admin-form textarea {
      min-height: 96px;
      resize: vertical;
    }
    .manager-admin-form .hint {
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
      line-height: 1.3;
    }
    .manager-admin-form-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .manager-admin-form select[multiple] {
      min-height: 110px;
      height: auto;
    }
    .manager-social-pane {
      display: grid;
      gap: 12px;
    }
    .manager-social-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 12px;
    }
    .manager-social-topbar h4 {
      margin: 0;
      font-size: 18px;
    }
    .manager-social-topbar .sub {
      color: var(--muted);
      font-size: 12px;
      margin-top: 3px;
    }
    .manager-plus-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid rgba(25,209,255,.25);
      background: linear-gradient(120deg, #19d1ff, #38e8ff);
      color: #0b1021;
      font-size: 22px;
      line-height: 1;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(25,209,255,.25);
    }
    .manager-social-compose {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 12px;
    }
    .manager-social-compose h4 { margin: 0 0 8px; font-size: 17px; }
    .manager-social-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .manager-social-grid .full { grid-column: 1 / -1; }
    .manager-social-compose input,
    .manager-social-compose select,
    .manager-social-compose textarea {
      width: 100%;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-family: inherit;
      font-size: 13px;
      transition: border .2s, box-shadow .2s;
    }
    .manager-social-compose input:focus,
    .manager-social-compose select:focus,
    .manager-social-compose textarea:focus {
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px rgba(25,209,255,.1);
    }
    .manager-social-compose textarea { min-height: 96px; resize: vertical; }
    .manager-social-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .manager-social-list { display: grid; gap: 12px; }
    .manager-social-card {
      background: rgba(255,255,255,0.03);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
    }
    .manager-social-head {
      display:flex; justify-content:space-between; gap:10px; align-items:baseline; margin-bottom:8px;
      flex-wrap: wrap;
    }
    .manager-social-title { font-weight:800; }
    .manager-social-date { color:var(--muted); font-size:12px; }
    .manager-social-text { white-space:pre-wrap; line-height:1.45; margin-bottom:8px; }
    .manager-social-meta { color: var(--muted); font-size: 12px; margin-bottom: 8px; }
    .manager-social-media img { max-width:100%; border-radius:10px; border:1px solid var(--border); display:block; }
    .manager-social-media video { width:100%; border-radius:10px; border:1px solid var(--border); display:block; }
    .manager-social-media iframe { width:100%; min-height:340px; border:none; border-radius:10px; display:block; background:#0f172a; }
    .manager-social-card-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .manager-social-file {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .manager-social-file input[type="file"] {
      max-width: 100%;
    }
    .manager-social-status {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      min-height: 16px;
    }
    .manager-social-inline-link {
      color: #9edbff;
      text-decoration: none;
      font-size: 12px;
    }

    .class-card {
      border: 1px solid var(--border);
      background: linear-gradient(150deg, var(--panel), var(--panel-soft));
      border-radius: 16px;
      padding: 14px;
      min-height: 146px;
      cursor: pointer;
      text-align: left;
      color: inherit;
      font: inherit;
      transition: transform .14s ease, border-color .14s ease, box-shadow .2s ease;
      position: relative;
    }

    .class-card:hover {
      transform: translateY(-2px);
      border-color: rgba(25, 209, 255, 0.35);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.28);
    }

    .class-card.active {
      border-color: rgba(25, 209, 255, 0.55);
      box-shadow: 0 0 0 2px rgba(25, 209, 255, 0.15) inset;
    }

    .class-gear {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #9eb3de;
      opacity: .95;
      font-size: 18px;
    }

    .class-dot {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .class-name {
      font-size: 24px;
      line-height: 1.1;
      margin-bottom: 6px;
      font-weight: 800;
    }

    .class-meta {
      color: var(--muted);
      font-size: 14px;
    }

    .chat {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(170deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      display: grid;
      grid-template-columns: 340px 1fr;
      min-height: 620px;
      overflow: hidden;
    }

    .chat-left {
      border-right: 1px solid var(--border);
      background: linear-gradient(180deg, #0f1830 0%, #0d152a 100%);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-left-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .chat-left-head h2 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .new-msg {
      border: 1px solid rgba(25,209,255,.25);
      background: linear-gradient(120deg, #19d1ff, #38e8ff);
      color: #0b1021;
      border-radius: 10px;
      padding: 7px 13px;
      font-weight: 700;
      cursor: pointer;
      font-size: 12px;
    }

    .rooms {
      display: grid;
      gap: 8px;
      overflow: auto;
      padding-right: 2px;
    }

    .room-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .room-btn:hover { background: rgba(255,255,255,.04); }

    .room-btn.active {
      background: rgba(25,209,255,.1);
      border-color: rgba(25,209,255,.3);
    }

    .room-main { display: flex; align-items: center; gap: 9px; min-width: 0; }

    .room-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--accent-cyan); flex: 0 0 auto; }
    .room-unread { width: 8px; height: 8px; border-radius: 50%; background:#ff4d5b; margin-left:auto; box-shadow:0 0 0 3px rgba(255,77,91,.2); display:none; }

    .room-title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .chat-right {
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: linear-gradient(180deg, #0c1428 0%, #0b1021 100%);
    }

    .chat-head {
      border-bottom: 1px solid var(--border);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .chat-head-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .chat-head-dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: var(--accent-cyan);
      box-shadow: 0 0 0 4px rgba(25, 209, 255, 0.15);
      flex: 0 0 auto;
    }

    .chat-head h3 {
      margin: 0;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-status {
      min-height: 18px;
      color: var(--muted);
      font-size: 12px;
      margin-left: auto;
    }

    .messages {
      flex: 1;
      overflow: auto;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 100%;
    }

    .msg-row.self {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #88d7ff, #5276bf);
      border: 1px solid rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #08142e;
      font-weight: 800;
      flex: 0 0 auto;
      position: relative;
      overflow: hidden;
    }

    .avatar::after {
      content: '';
      position: absolute;
      right: 1px;
      bottom: 1px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--ok);
      border: 1px solid #0d1731;
    }

    .bubble-wrap {
      max-width: min(72%, 620px);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .bubble {
      border-radius: 14px;
      padding: 10px 12px;
      line-height: 1.35;
      font-size: 14px;
      word-break: break-word;
      border: 1px solid rgba(255,255,255,.08);
      background: var(--bubble-other);
      color: #edf2ff;
    }

    .msg-row.self .bubble {
      background: var(--bubble-self);
      border-color: rgba(61, 117, 227, .35);
      color: #f3f7ff;
    }

    .meta {
      font-size: 11px;
      color: #95a4c8;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 0 2px;
    }

    .msg-row.self .meta { color: #8fa7d8; }

    .composer {
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 40px 1fr 92px;
      gap: 10px;
      align-items: center;
    }

    .composer-side {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .composer input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 11px 14px;
      font-size: 14px;
      outline: none;
      transition: border .2s, box-shadow .2s;
      font-family: inherit;
    }
    .composer input:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(25,209,255,.1); }

    .composer input::placeholder { color: #8f9bb8; }

    .send-btn {
      width: 92px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(120deg, var(--primary), var(--primary-2));
      color: #fff;
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
    }

    .attach-pill {
      display: none;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(25, 209, 255, 0.35);
      background: rgba(25, 209, 255, 0.12);
      color: #d6f8ff;
      border-radius: 10px;
      padding: 6px 10px;
      margin: 8px 12px 0;
      width: fit-content;
      max-width: calc(100% - 24px);
      font-size: 12px;
    }

    .attach-pill-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }

    .attach-pill button {
      border: none;
      background: transparent;
      color: #d6f8ff;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }

    .bubble-attachment {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bubble-attachment a {
      color: #9edbff;
      text-decoration: none;
      font-size: 13px;
    }

    .bubble-attachment img {
      max-width: 220px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.18);
    }

    .empty {
      color: var(--muted);
      font-size: 14px;
      padding: 8px;
      text-align: center;
      border: 1px dashed rgba(255,255,255,.15);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
    }
    .teacher-box {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.015);
      padding: 22px 24px;
      min-height: 300px;
      position: relative;
      overflow: hidden;
    }
    .teacher-box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #19d1ff 0%, rgba(25,209,255,0.2) 100%);
      border-radius: 16px 16px 0 0;
    }
    .teacher-box h3 {
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.02em;
      padding-top: 4px;
    }
    .teacher-list { display: block; }
    .teacher-methods-toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .teacher-methods-toolbar select {
      min-width: 240px;
      max-width: 420px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
      font-family: inherit;
    }
    .teacher-methods-count {
      color: var(--muted);
      font-size: 13px;
    }
    .teacher-item-meta { color: var(--muted); font-size: 12px; }
    .method-number-pill {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 12px;
      font-weight: 700;
      color: #dff7ff;
      background: rgba(25,209,255,0.18);
      border: 1px solid rgba(25,209,255,0.35);
      white-space: nowrap;
    }
    .methods-template-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
    }
    .methods-template {
      border-collapse: collapse;
      width: 100%;
      min-width: 640px;
    }
    .methods-template th,
    .methods-template td {
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      vertical-align: middle;
      text-align: left;
    }
    .methods-template th {
      background: rgba(25,209,255,0.08);
      color: #e5f7ff;
      font-weight: 700;
    }
    .methods-template tr:last-child td { border-bottom: none; }
    .methods-template-number {
      width: 80px;
      font-weight: 700;
      color: #cfe7ff;
    }
    .methods-template-title {
      color: #f2f6ff;
    }
    .methods-template-title.placeholder {
      color: var(--muted);
      font-style: italic;
    }
    .methods-template-open {
      width: 190px;
    }
    .method-link { color: #9edbff; text-decoration: none; font-size: 13px; }
    .method-actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .method-btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      text-decoration: none;
    }
    .method-viewer {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255,255,255,.03);
      color: #edf2ff;
    }
    .method-viewer-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .method-viewer h3 { margin:0; }
    .method-collapse-btn {
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:#d6e5ff;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:700;
    }
    .week-nav { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .week-nav-title { color: var(--muted); }
    .week-nav-controls { display:flex; align-items:center; gap:8px; }
    .week-nav-btn { border:none; width:32px; height:32px; border-radius:50%; background:rgba(25,209,255,0.2); color:#9bf3ff; font-size:20px; line-height:1; cursor:pointer; }
    .week-range { color: var(--muted); font-weight:700; min-width:170px; text-align:center; }
    .week-grid { overflow-x:auto; }
    .week-table { border-collapse: collapse; min-width: 900px; width: 100%; }
    .week-table th, .week-table td { border:1px solid var(--border); padding:8px; vertical-align:top; }
    .week-table th { background: rgba(25,209,255,0.08); color: #e5e7eb; font-weight:700; text-align:center; }
    .week-table td { background: rgba(255,255,255,0.02); min-height:80px; }
    .slot-card { background: rgba(255,255,255,0.06); border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:6px; }
    .slot-title { font-weight:700; }
    .slot-subject { color: #dbe7ff; font-size: 12px; margin-top: 2px; line-height: 1.25; }
    .slot-time { color: var(--muted); font-size:12px; }
    .method-block { margin:0 0 12px; }
    .method-block h3 { margin:0 0 8px; font-size:24px; line-height:1.25; }
    .method-quote { border-left:4px solid #6d8ed6; background:#eaf0ff; color:#27334d; padding:12px 14px; border-radius:8px; }
    .method-block img { max-width:100%; border-radius:10px; border:1px solid var(--border); }
    .method-block iframe { width:100%; min-height:340px; border:none; border-radius:10px; }
    .method-cap { color:var(--muted); font-size:13px; margin-top:4px; }
    .assignment-panel {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.02);
    }
    .assignment-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .assignment-title { font-weight: 700; }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: #eef4ff;
    }
    .status-badge.todo { background: rgba(255,255,255,.05); }
    .status-badge.in_progress { background: rgba(25,209,255,.12); border-color: rgba(25,209,255,.25); color: #bdf4ff; }
    .status-badge.review { background: rgba(255,193,7,.12); border-color: rgba(255,193,7,.25); color: #ffe49a; }
    .status-badge.done { background: rgba(54,201,143,.12); border-color: rgba(54,201,143,.25); color: #bff6df; }
    .assignment-meta { color: var(--muted); font-size: 12px; margin-bottom: 8px; }
    .assignment-comments {
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
      margin: 8px 0;
      padding-right: 4px;
    }
    .assignment-comment {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(255,255,255,.03);
    }
    .assignment-comment.self {
      border-color: rgba(25,209,255,.3);
      background: rgba(25,209,255,.08);
    }
    .assignment-comment-meta {
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .assignment-comment-text { white-space: pre-wrap; line-height: 1.35; }
    .assignment-comment-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-top: 8px;
    }
    .assignment-comment-form input {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-family: inherit;
      transition: border .2s;
    }
    .assignment-comment-form input:focus { border-color: var(--accent-cyan); }
    .dev-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .dev-list {
      display: grid;
      gap: 8px;
      max-height: 620px;
      overflow: auto;
      padding-right: 4px;
    }
    .dev-card {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
    }
    .dev-card.active {
      border-color: rgba(25,209,255,.35);
      box-shadow: inset 0 0 0 1px rgba(25,209,255,.1);
      background: rgba(25,209,255,.06);
    }
    .dev-card-title { font-weight: 700; margin-bottom: 4px; }
    .dev-card-meta { color: var(--muted); font-size: 12px; line-height: 1.35; }
    .dev-detail {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.02);
      min-height: 240px;
    }
    .dev-detail-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .dev-detail-title { font-weight: 800; font-size: 18px; }
    .dev-detail-meta { color: var(--muted); font-size: 12px; margin-bottom: 8px; line-height:1.35; }
    .dev-comments {
      display:grid;
      gap:8px;
      max-height: 260px;
      overflow:auto;
      margin-top: 8px;
      padding-right: 4px;
    }
    .dev-comment {
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      background: rgba(255,255,255,.03);
    }
    .dev-comment.self {
      border-color: rgba(25,209,255,.3);
      background: rgba(25,209,255,.07);
    }
    .dev-comment-meta {
      display:flex;
      justify-content:space-between;
      gap:8px;
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 4px;
    }
    .dev-comment-text { white-space: pre-wrap; line-height: 1.35; }
    .dev-comment-form {
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      margin-top:8px;
    }
    .dev-comment-form input {
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      font-family:inherit;
      outline:none;
      transition:border .2s;
    }
    .dev-comment-form input:focus { border-color: var(--accent-cyan); }
    .dev-editor {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,.02);
    }
    .dev-editor h4 { margin: 0 0 8px; font-size: 15px; }
    .dev-editor label { margin-top: 8px; }
    .dev-editor-toolbar { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    .dev-blocks { display:grid; gap:8px; }
    .dev-block, .block-item {
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px;
      background: rgba(255,255,255,.03);
    }
    .dev-block-head, .block-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .dev-block-title, .block-kind { color: var(--muted); font-size: 12px; }
    .dev-block-actions, .block-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .dev-block-actions button, .block-actions button {
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
    }
    .dev-block textarea, .block-item textarea { min-height: 70px; }
    .dev-preview {
      margin-top: 8px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255,255,255,.02);
    }
    .dev-save-row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 8px;
    }
    .dev-save-status { color: var(--muted); font-size: 12px; }
    .live-page {
      background:#f5f7fb;
      color:#1d2433;
      border-radius:12px;
      border:1px solid #dfe5f1;
      padding:20px;
      min-height:240px;
    }
    .live-header { text-align:center; margin-bottom:18px; }
    .live-badge { display:inline-block; padding:8px 14px; border-radius:999px; background:#eaf2ff; color:#2f5cab; font-size:12px; font-weight:700; margin-bottom:8px; }
    .live-title { margin:0; font-size:26px; line-height:1.2; font-weight:800; color:#17203a; }
    .live-desc { margin:10px auto 0; max-width:820px; color:#52607a; }
    .live-material-link { display:inline-block; margin-top:10px; padding:8px 12px; border-radius:10px; background:#1f6feb; color:#fff; font-weight:700; text-decoration:none; }
    .live-block { margin:16px 0; }
    .live-block h3 { margin:0 0 8px; font-size:25px; line-height:1.25; }
    .live-block p { margin:0; line-height:1.65; }
    .live-quote { border-left:4px solid #6d8ed6; background:#eaf0ff; color:#27334d; padding:12px 14px; border-radius:8px; }
    .live-block img { max-width:100%; border-radius:10px; border:1px solid #d8dfef; display:block; }
    .live-block iframe { width:100%; min-height:340px; border:none; border-radius:10px; background:#0f172a; display:block; }
    .live-caption { margin-top:6px; font-size:12px; color:#66758f; }
    input[type="color"] { height:38px; min-width:58px; padding:4px; }

    @media (max-width: 1180px) {
      .chat { grid-template-columns: 1fr; min-height: 720px; }
      .chat-left { border-right: none; border-bottom: 1px solid var(--border); }
      .dev-grid { grid-template-columns: 1fr; }
      .portal-layout.teacher-layout { grid-template-columns: 1fr; gap: 12px; }
      .portal-layout.teacher-layout .portal-tabs {
        position: static;
        flex-direction: row;
        flex-wrap: wrap;
        padding: 8px;
      }
      .portal-nav-label { display: none; }
      .portal-layout.teacher-layout .portal-tab-btn {
        width: auto;
        text-align: center;
        padding: 8px 12px;
        font-size: 13px;
      }
      .manager-admin-layout { grid-template-columns: 1fr; }
      .manager-admin-nav {
        position: static;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .manager-admin-grid { grid-template-columns: 1fr; }
      .manager-admin-toolbar { grid-template-columns: 1fr; }
      .manager-social-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 760px) {
      body { padding: 12px; }
      .classes { grid-template-columns: 1fr 1fr; gap: 10px; }
      .class-card { min-height: 130px; }
      .class-dot { width: 46px; height: 46px; margin-bottom: 8px; }
      .class-name { font-size: 18px; }
      .class-meta { font-size: 12px; }
      .composer { grid-template-columns: 1fr 84px; }
      .composer-side { display: none; }
      .bubble-wrap { max-width: 84%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>{{ portal_title }}</h1>
      <div class="top-right">
        <div id="who" class="who">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>
        <button id="chat-bell" class="bell-btn" type="button">üîî<span id="chat-bell-count" class="bell-count"></span></button>
        <button id="logout" class="logout" type="button">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div id="portal-layout" class="portal-layout">
      <div id="portal-tabs" class="portal-tabs">
        <div class="portal-nav-label">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <button class="portal-tab-btn active" data-view="chat" type="button">üí¨ –ß–∞—Ç</button>
        <button class="portal-tab-btn" data-view="schedule" type="button">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        <button class="portal-tab-btn" data-view="methods" type="button">üìö –ú–µ—Ç–æ–¥—ã</button>
        <button class="portal-tab-btn" data-view="development" type="button">üõ† –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞</button>
        <button class="portal-tab-btn" data-view="manage" type="button">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
        <button class="portal-tab-btn" data-view="events" type="button">üì¢ –°–æ–±—ã—Ç–∏—è</button>
        <button class="portal-tab-btn" data-view="feed" type="button">üì∞ –õ–µ–Ω—Ç–∞</button>
      </div>

      <div id="portal-content" class="portal-content">
    <section id="pane-chat" class="content-pane active">
    <div id="classes" class="classes"></div>
    <section class="chat">
      <aside class="chat-left">
        <div class="chat-left-head">
          <h2>–ß–∞—Ç—ã</h2>
          <button id="new-msg" class="new-msg" type="button">–ù–æ–≤–æ–µ</button>
        </div>
        <div id="rooms" class="rooms"></div>
      </aside>

      <div class="chat-right">
        <div class="chat-head">
          <div class="chat-head-title">
            <span class="chat-head-dot"></span>
            <h3 id="chat-title-text">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
          </div>
          <div id="status" class="chat-status"></div>
        </div>

        <div id="messages" class="messages">
          <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ —á–∞—Ç</div>
        </div>

        <div id="attach-pill" class="attach-pill">
          <span class="attach-pill-name" id="attach-pill-name"></span>
          <button id="attach-clear" type="button">–£–±—Ä–∞—Ç—å</button>
        </div>

        <div class="composer">
          <button class="composer-side" id="attach-btn" type="button">üìé</button>
          <input id="attachment-input" type="file" hidden />
          <input id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
          <button id="send-btn" class="send-btn" type="button">Send <span>‚û§</span></button>
        </div>
      </div>
    </section>
    </section>

    <section id="pane-schedule" class="content-pane">
      <div class="teacher-box">
        <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h3>
        <div class="week-nav">
          <div id="teacher-week-title" class="week-nav-title"></div>
          <div class="week-nav-controls">
            <button id="teacher-week-prev" type="button" class="week-nav-btn">‚Äπ</button>
            <div id="teacher-week-range" class="week-range"></div>
            <button id="teacher-week-next" type="button" class="week-nav-btn">‚Ä∫</button>
          </div>
        </div>
        <div class="week-grid">
          <table class="week-table">
            <thead>
              <tr id="teacher-schedule-head-row"></tr>
            </thead>
            <tbody id="teacher-schedule-body-grid"></tbody>
          </table>
        </div>
        <div id="teacher-schedule-status" class="empty" style="margin-top:8px;">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ß–∞—Ç"</div>
      </div>
    </section>

    <section id="pane-methods" class="content-pane">
      <div class="teacher-box">
        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥–ø–∞–∫–µ—Ç—ã</h3>
        <div class="teacher-methods-toolbar">
          <select id="teacher-methods-subject-filter">
            <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
          </select>
          <div id="teacher-methods-count" class="teacher-methods-count"></div>
        </div>
        <div id="teacher-methods-list" class="teacher-list">
          <div class="empty">–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</div>
        </div>
        <div id="teacher-method-viewer" class="method-viewer">
          –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥–ø–∞–∫–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å"
        </div>
      </div>
    </section>

    <section id="pane-development" class="content-pane">
      <div class="teacher-box">
        <h3>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–æ–¥–ø–∞–∫–µ—Ç–æ–≤</h3>
        <div id="teacher-dev-summary" class="teacher-item-meta" style="margin-bottom:8px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="dev-grid">
          <div id="teacher-dev-list" class="dev-list">
            <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
          <div id="teacher-dev-detail" class="dev-detail">
            –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–µ–≤–∞
          </div>
        </div>
      </div>
    </section>

    <section id="pane-manage" class="content-pane">
      <div class="teacher-box">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–±–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º</h3>
        <div class="manager-inline-status">–í—Å–µ —Ñ–æ—Ä–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä—è–º–æ –∑–¥–µ—Å—å. –ë–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É.</div>
        <div class="manager-admin-layout">
          <div id="manager-admin-nav" class="manager-admin-nav">
            <button class="manager-admin-nav-btn active" data-manager-tab="groups" type="button">–ì—Ä—É–ø–ø—ã</button>
            <button class="manager-admin-nav-btn" data-manager-tab="students" type="button">–£—á–µ–Ω–∏–∫–∏</button>
            <button class="manager-admin-nav-btn" data-manager-tab="parents" type="button">–†–æ–¥–∏—Ç–µ–ª–∏</button>
            <button class="manager-admin-nav-btn" data-manager-tab="teachers" type="button">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</button>
            <button class="manager-admin-nav-btn" data-manager-tab="schedule" type="button">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
            <button class="manager-admin-nav-btn" data-manager-tab="holidays" type="button">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
          </div>
          <div class="manager-admin-main">
            <div class="manager-admin-toolbar">
              <input id="manager-admin-search" placeholder="–ü–æ–∏—Å–∫..." />
              <select id="manager-admin-filter"></select>
              <button id="manager-admin-create" class="manager-link-btn primary" type="button">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
            <div class="manager-admin-grid">
              <div class="manager-admin-list">
                <div id="manager-admin-list-status" class="manager-inline-status"></div>
                <div id="manager-admin-list" class="manager-admin-list-items"></div>
              </div>
              <div id="manager-admin-form-wrap" class="manager-admin-form">
                <div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å".</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="pane-events" class="content-pane">
      <div class="teacher-box">
        <h3>–°–æ–±—ã—Ç–∏—è –≥—Ä—É–ø–ø—ã</h3>
        <div id="manager-events-pane" class="manager-social-pane"></div>
      </div>
    </section>

    <section id="pane-feed" class="content-pane">
      <div class="teacher-box">
        <h3>–õ–µ–Ω—Ç–∞ –≥—Ä—É–ø–ø—ã</h3>
        <div id="manager-feed-pane" class="manager-social-pane"></div>
      </div>
    </section>
      </div>
    </div>
  </div>

  <script>
    const ROLE = '{{ portal_role }}';
    const CLASS_COLORS = ['#19d1ff', '#ff79b0', '#ff8c23', '#7a46ff', '#4dd37d', '#ff5f86'];

    const state = {
      token: '',
      me: null,
      myDisplayName: '',
      mySenderType: '',
      selectedFile: null,
      rooms: [],
      groups: [],
      activeGroupId: null,
      activeRoomId: null,
      unreadRoomIds: new Set(),
      pollTimer: null,
      activeView: 'chat',
      scheduleSlots: [],
      scheduleWeekOffset: 0,
      methods: [],
      openMethodId: null,
      assignments: [],
      assignmentCommentsCache: {},
      devAssignmentId: null,
      devEditorMethodId: null,
      devEditorDraft: null,
      managerAdmin: {
        tab: 'groups',
        selectedId: null,
        records: {},
        refs: { groups: [], parents: [], students: [], subjects: [], methods: [] },
      },
      managerEvents: [],
      managerFeed: [],
      managerEventEditId: null,
      managerFeedEditId: null,
      managerEventComposeOpen: false,
      managerFeedComposeOpen: false,
    };

    function $(id) { return document.getElementById(id); }

    function portalKey(suffix) {
      return `portal:${ROLE}:${suffix}`;
    }

    function portalSafeGet(key) {
      try { return sessionStorage.getItem(key); } catch (_) { return null; }
    }

    function portalSafeSet(key, value) {
      try { sessionStorage.setItem(key, String(value)); } catch (_) {}
    }

    function esc(text) {
      return String(text || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function shortName(full) {
      const value = String(full || '').trim();
      if (!value) return 'U';
      return value.split(/\s+/).slice(0, 2).map((w) => w[0] || '').join('').toUpperCase() || 'U';
    }

    function parseDate(dateStr) {
      if (!dateStr) return null;
      const d = new Date(`${dateStr}T00:00:00`);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function getMonday(baseDate = new Date(), offsetWeeks = 0) {
      const d = new Date(baseDate);
      d.setHours(0, 0, 0, 0);
      const day = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - day + (offsetWeeks * 7));
      return d;
    }

    function formatDate(d) {
      return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function formatDateRange(a, b) {
      const fa = `${formatDate(a)}.${String(a.getFullYear()).slice(-2)}`;
      const fb = `${formatDate(b)}.${String(b.getFullYear()).slice(-2)}`;
      return `${fa} - ${fb}`;
    }

    function hhmm(timeStr) {
      const raw = String(timeStr || '');
      return raw.length >= 5 ? raw.slice(0, 5) : raw;
    }

    function addMinutesToTime(timeStr, minutes) {
      const clean = hhmm(timeStr);
      if (!clean || !clean.includes(':')) return clean;
      const [h, m] = clean.split(':').map(Number);
      if (Number.isNaN(h) || Number.isNaN(m)) return clean;
      const total = (h * 60) + m + minutes;
      const norm = ((total % (24 * 60)) + (24 * 60)) % (24 * 60);
      const nh = Math.floor(norm / 60);
      const nm = norm % (60);
      return `${String(nh).padStart(2, '0')}:${String(nm).padStart(2, '0')}`;
    }

    async function api(url, method = 'GET', body = null) {
      const headers = {};
      const isFormData = body instanceof FormData;
      if (!isFormData) headers['Content-Type'] = 'application/json';
      if (state.token) headers.Authorization = `Bearer ${state.token}`;
      const res = await fetch(url, { method, headers, body: body ? (isFormData ? body : JSON.stringify(body)) : null });
      if (!res.ok) throw new Error(await res.text() || res.statusText);
      if (res.status === 204) return null;
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) return null;
      return res.json();
    }

    async function uploadMedia(file) {
      const fd = new FormData();
      fd.append('file', file);
      const data = await api('/api/upload/', 'POST', fd);
      const rawUrl = data && data.url ? String(data.url) : '';
      if (!rawUrl) return '';
      return rawUrl.startsWith('http') ? rawUrl : `${window.location.origin}${rawUrl}`;
    }

    function openTeacherMethodConstructor(methodObj) {
      if (!methodObj) return;
      try {
        if (state.token) localStorage.setItem('consoleAccessToken', state.token);
      } catch (_) {}
      const returnTo = `${window.location.pathname}${window.location.search || ''}`;
      window.open(`/console/create/methods/?id=${methodObj.id}&return_to=${encodeURIComponent(returnTo)}&return_view=development`, '_blank');
    }

    function updateAttachmentPill() {
      const pill = $('attach-pill');
      const label = $('attach-pill-name');
      if (!state.selectedFile) {
        pill.style.display = 'none';
        label.textContent = '';
        return;
      }
      pill.style.display = 'inline-flex';
      label.textContent = state.selectedFile.name || '–§–∞–π–ª';
    }

    function isImageAttachment(url, name) {
      const raw = String(name || url || '').toLowerCase();
      return ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.bmp', '.svg'].some((ext) => raw.includes(ext));
    }

    function roomLabel(room) {
      if (room.room_type === 'parents') return `–†–æ–¥–∏—Ç–µ–ª–∏ ${room.group_name || room.group}`;
      if (room.room_type === 'management') return `–ú–µ–Ω–µ–¥–∂–µ—Ä –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å ${room.group_name || room.group}`;
      return `–°—Ç—É–¥–µ–Ω—Ç—ã ${room.group_name || room.group}`;
    }

    async function resolveMyDisplayName() {
      state.mySenderType = ROLE === 'teacher'
        ? 'teacher'
        : ROLE === 'manager'
          ? 'manager'
          : ROLE === 'parent'
            ? 'parent'
            : 'student';
      try {
        if (ROLE === 'teacher') {
          const list = await api('/api/teachers/');
          const self = Array.isArray(list) ? list.find((x) => x.username === state.me.username) : null;
          if (self) state.myDisplayName = `${self.last_name || ''} ${self.first_name || ''}`.trim();
        } else if (ROLE === 'parent') {
          const list = await api('/api/parents/');
          const self = Array.isArray(list) ? list.find((x) => x.username === state.me.username) : null;
          if (self) state.myDisplayName = `${self.last_name || ''} ${self.first_name || ''}`.trim();
        } else {
          const list = await api('/api/students/');
          const self = Array.isArray(list) ? list.find((x) => x.username === state.me.username) : null;
          if (self) state.myDisplayName = `${self.last_name || ''} ${self.first_name || ''}`.trim();
        }
      } catch (_) {
        state.myDisplayName = state.me.username || '';
      }
      if (!state.myDisplayName) state.myDisplayName = state.me.username || '';
    }

    function isSelfMessage(msg) {
      const sender = String(msg.sender_name || '').trim().toLowerCase();
      const mine = String(state.myDisplayName || '').trim().toLowerCase();
      if (sender && mine && sender === mine) return true;
      return msg.sender_type === state.mySenderType;
    }

    function seenKey(roomId) {
      const user = state.me && state.me.username ? state.me.username : 'unknown';
      return `chat_seen:${user}:room:${roomId}`;
    }

    function getSeenId(roomId) {
      const raw = localStorage.getItem(seenKey(roomId));
      const parsed = Number(raw || 0);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function setSeenId(roomId, messageId) {
      const id = Number(messageId || 0);
      if (!id) return;
      const prev = getSeenId(roomId);
      if (id > prev) localStorage.setItem(seenKey(roomId), String(id));
    }

    function updateBellUI() {
      const count = state.unreadRoomIds.size;
      const badge = $('chat-bell-count');
      badge.style.display = count > 0 ? 'flex' : 'none';
      badge.textContent = String(Math.min(count, 99));
    }

    function switchView(view) {
      state.activeView = view;
      portalSafeSet(portalKey('active_view'), view);
      ['chat', 'schedule', 'methods', 'development', 'manage', 'events', 'feed'].forEach((name) => {
        const pane = $(`pane-${name}`);
        if (pane) pane.classList.toggle('active', name === view);
      });
      document.querySelectorAll('.portal-tab-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      if (view === 'schedule') loadTeacherSchedule();
      if (view === 'methods') loadTeacherMethods();
      if (view === 'development') loadTeacherDevelopment();
      if (view === 'chat') loadMessages();
      if (ROLE === 'manager' && view === 'events') managerLoadEvents().catch((e) => { const b = $('manager-events-pane'); if (b) b.innerHTML = `<div class="empty">${esc(e.message)}</div>`; });
      if (ROLE === 'manager' && view === 'feed') managerLoadFeed().catch((e) => { const b = $('manager-feed-pane'); if (b) b.innerHTML = `<div class="empty">${esc(e.message)}</div>`; });
    }

    const MANAGER_CFG = {
      groups: {
        title: '–ì—Ä—É–ø–ø—ã',
        endpoint: '/api/groups/',
        filterLabel: '–í—Å–µ',
        columnsLabel: (r) => r.name || `–ì—Ä—É–ø–ø–∞ ${r.id}`,
        meta: (r) => `${(r.students || []).length} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ¬∑ ${(r.teachers || []).length} –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π`,
        formTitle: (r) => r ? `–ì—Ä—É–ø–ø–∞: ${r.name || r.id}` : '–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞',
        fields: [
          { key: 'name', label: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', required: true, full: true },
          { key: 'description', label: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', full: true },
          { key: 'student_ids', label: '–£—á–µ–Ω–∏–∫–∏ –≤ –≥—Ä—É–ø–ø–µ (–¥–æ–±–∞–≤–∏—Ç—å/–ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å)', type: 'multiselect', options: 'students', full: true },
        ],
      },
      students: {
        title: '–£—á–µ–Ω–∏–∫–∏',
        endpoint: '/api/students/',
        filterLabel: '–í—Å–µ –≥—Ä—É–ø–ø—ã',
        filterType: 'groups',
        columnsLabel: (r) => `${r.last_name || ''} ${r.first_name || ''}`.trim() || `–£—á–µ–Ω–∏–∫ ${r.id}`,
        meta: (r) => `${r.group_name || `–ì—Ä—É–ø–ø–∞ ${r.group || '‚Äî'}`} ¬∑ –ª–æ–≥–∏–Ω: ${r.username || '‚Äî'}`,
        formTitle: (r) => r ? `–£—á–µ–Ω–∏–∫: ${(r.last_name || '')} ${(r.first_name || '')}`.trim() : '–ù–æ–≤—ã–π —É—á–µ–Ω–∏–∫',
        fields: [
          { key: 'last_name', label: '–§–∞–º–∏–ª–∏—è', type: 'text', required: true },
          { key: 'first_name', label: '–ò–º—è', type: 'text', required: true },
          { key: 'group', label: '–ì—Ä—É–ø–ø–∞', type: 'select', options: 'groups', required: true },
          { key: 'parents', label: '–†–æ–¥–∏—Ç–µ–ª–∏', type: 'multiselect', options: 'parents', full: true },
          { key: 'notes', label: '–ó–∞–º–µ—Ç–∫–∏', type: 'textarea', full: true },
        ],
      },
      parents: {
        title: '–†–æ–¥–∏—Ç–µ–ª–∏',
        endpoint: '/api/parents/',
        filterLabel: '–í—Å–µ',
        columnsLabel: (r) => `${r.last_name || ''} ${r.first_name || ''}`.trim() || `–†–æ–¥–∏—Ç–µ–ª—å ${r.id}`,
        meta: (r) => `${r.phone || '–±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'} ¬∑ ${r.email || '–±–µ–∑ email'} ¬∑ –ª–æ–≥–∏–Ω: ${r.username || '‚Äî'}`,
        formTitle: (r) => r ? `–†–æ–¥–∏—Ç–µ–ª—å: ${(r.last_name || '')} ${(r.first_name || '')}`.trim() : '–ù–æ–≤—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å',
        fields: [
          { key: 'last_name', label: '–§–∞–º–∏–ª–∏—è', type: 'text', required: true },
          { key: 'first_name', label: '–ò–º—è', type: 'text', required: true },
          { key: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text' },
          { key: 'email', label: 'Email', type: 'email' },
        ],
      },
      teachers: {
        title: '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏',
        endpoint: '/api/teachers/',
        filterLabel: '–í—Å–µ –≥—Ä—É–ø–ø—ã',
        filterType: 'groups',
        columnsLabel: (r) => `${r.last_name || ''} ${r.first_name || ''}`.trim() || `–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å ${r.id}`,
        meta: (r) => `${r.email || '–±–µ–∑ email'} ¬∑ –≥—Ä—É–ø–ø: ${Array.isArray(r.groups) ? r.groups.length : 0} ¬∑ –ª–æ–≥–∏–Ω: ${r.username || '‚Äî'}`,
        formTitle: (r) => r ? `–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: ${(r.last_name || '')} ${(r.first_name || '')}`.trim() : '–ù–æ–≤—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å',
        fields: [
          { key: 'last_name', label: '–§–∞–º–∏–ª–∏—è', type: 'text', required: true },
          { key: 'first_name', label: '–ò–º—è', type: 'text', required: true },
          { key: 'phone', label: '–¢–µ–ª–µ—Ñ–æ–Ω', type: 'text' },
          { key: 'email', label: 'Email', type: 'email' },
          { key: 'groups', label: '–ì—Ä—É–ø–ø—ã', type: 'multiselect', options: 'groups', full: true },
        ],
      },
      holidays: {
        title: '–ü—Ä–∞–∑–¥–Ω–∏–∫–∏',
        endpoint: '/api/holidays/',
        filterLabel: '–í—Å–µ –≥—Ä—É–ø–ø—ã',
        filterType: 'groupsPlusGlobal',
        columnsLabel: (r) => `${r.date || ''} ¬∑ ${r.title || '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å'}`,
        meta: (r) => r.group_name ? `–î–ª—è –≥—Ä—É–ø–ø—ã: ${r.group_name}` : '–î–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø',
        formTitle: (r) => r ? `–ü—Ä–∞–∑–¥–Ω–∏–∫: ${r.date || ''}` : '–ù–æ–≤—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫',
        fields: [
          { key: 'date', label: '–î–∞—Ç–∞', type: 'date', required: true },
          { key: 'title', label: '–ù–∞–∑–≤–∞–Ω–∏–µ', type: 'text', full: true },
          { key: 'group', label: '–ì—Ä—É–ø–ø–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)', type: 'selectOptional', options: 'groups', full: true },
        ],
      },
      schedule: {
        title: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ',
        endpoint: '/api/schedule/',
        filterLabel: '–í—Å–µ –≥—Ä—É–ø–ø—ã',
        filterType: 'groups',
        columnsLabel: (r) => `${r.lesson_date || '–±–µ–∑ –¥–∞—Ç—ã'} ¬∑ ${hhmm(r.start_time)} ¬∑ –ø–∞—Ä–∞ ${r.lesson_number || '‚Äî'}`,
        meta: (r) => `${r.group_name || `–ì—Ä—É–ø–ø–∞ ${r.group || '‚Äî'}`} ¬∑ ${r.method_package ? (r.method_package.title || '–ú–µ—Ç–æ–¥') : '–±–µ–∑ –º–µ—Ç–æ–¥–∞'}${r.moved_from_date ? ` ¬∑ –ø–µ—Ä–µ–Ω–æ—Å —Å ${r.moved_from_date}` : ''}`,
        formTitle: (r) => r ? `–°–ª–æ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è #${r.id}` : '–ù–æ–≤–∞—è –ø–∞—Ä–∞ (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º)',
        fields: [
          { key: 'group', label: '–ì—Ä—É–ø–ø–∞', type: 'select', options: 'groups', required: true },
          { key: 'subject_id', label: '–ü—Ä–µ–¥–º–µ—Ç', type: 'select', options: 'subjects', required: true },
          { key: 'start_method_number', label: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä –º–µ—Ç–æ–¥–∞', type: 'number', min: 1, max: 12, default: 1 },
          { key: 'lesson_date', label: '–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è', type: 'date', required: true },
          { key: 'lesson_number', label: '–ù–æ–º–µ—Ä –ø–µ—Ä–≤–æ–π –ø–∞—Ä—ã', type: 'number', min: 1, default: 1 },
          { key: 'start_time', label: '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞', type: 'time', required: true },
          { key: 'occurrences_count', label: '–ù–µ–¥–µ–ª—å (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)', type: 'number', min: 1, max: 52, default: 6 },
          { key: 'duration_minutes', label: '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)', type: 'number', min: 30, default: 80 },
          { key: 'method_package_id', label: '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ—Ç–∞)', type: 'selectOptional', options: 'methods', full: true },
          { key: 'apply_from_lesson_number', label: '–ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∞—Ç—å –º–µ—Ç–æ–¥—ã —Å —É—Ä–æ–∫–∞ ‚Ññ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)', type: 'number', min: 1, full: true },
        ],
      },
    };

    function managerListKey(tab) { return `mgr:${tab}`; }

    function managerCurrentCfg() { return MANAGER_CFG[state.managerAdmin.tab]; }

    async function managerEnsureRefs() {
      const needs = [];
      if (!state.managerAdmin.refs.groups.length) needs.push(api('/api/groups/').then((d) => { state.managerAdmin.refs.groups = d || []; }));
      if (!state.managerAdmin.refs.parents.length) needs.push(api('/api/parents/').then((d) => { state.managerAdmin.refs.parents = d || []; }));
      if (!state.managerAdmin.refs.students.length) needs.push(api('/api/students/').then((d) => { state.managerAdmin.refs.students = d || []; }));
      if (!state.managerAdmin.refs.subjects.length) needs.push(api('/api/subjects/').then((d) => { state.managerAdmin.refs.subjects = d || []; }));
      if (!state.managerAdmin.refs.methods.length) needs.push(api('/api/method-packages/').then((d) => { state.managerAdmin.refs.methods = d || []; }));
      if (needs.length) await Promise.all(needs);
    }

    function managerRefOptions(type) {
      if (type === 'groups') return (state.managerAdmin.refs.groups || []).map((g) => ({ value: g.id, label: g.name || `–ì—Ä—É–ø–ø–∞ ${g.id}` }));
      if (type === 'parents') return (state.managerAdmin.refs.parents || []).map((p) => ({ value: p.id, label: `${p.last_name || ''} ${p.first_name || ''}`.trim() || `–†–æ–¥–∏—Ç–µ–ª—å ${p.id}` }));
      if (type === 'students') return (state.managerAdmin.refs.students || []).map((s) => ({ value: s.id, label: `${s.last_name || ''} ${s.first_name || ''}`.trim() || `–£—á–µ–Ω–∏–∫ ${s.id}` }));
      if (type === 'subjects') return (state.managerAdmin.refs.subjects || []).map((s) => ({ value: s.id, label: s.name || `–ü—Ä–µ–¥–º–µ—Ç ${s.id}` }));
      if (type === 'methods') {
        return (state.managerAdmin.refs.methods || []).map((m) => ({
          value: m.id,
          label: `${m.subject_name || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'} ¬∑ ${m.method_number || '‚Äî'} ¬∑ ${m.title || `–ú–µ—Ç–æ–¥ ${m.id}`}`,
        }));
      }
      return [];
    }

    function managerStorageGetSearch() {
      return sessionStorage.getItem(managerListKey(`${state.managerAdmin.tab}:search`)) || '';
    }
    function managerStorageSetSearch(value) {
      sessionStorage.setItem(managerListKey(`${state.managerAdmin.tab}:search`), value || '');
    }
    function managerStorageGetFilter() {
      return sessionStorage.getItem(managerListKey(`${state.managerAdmin.tab}:filter`)) || '';
    }
    function managerStorageSetFilter(value) {
      sessionStorage.setItem(managerListKey(`${state.managerAdmin.tab}:filter`), value || '');
    }

    async function managerLoadRecords(force = false) {
      const cfg = managerCurrentCfg();
      if (!cfg) return;
      if (!force && Array.isArray(state.managerAdmin.records[cfg.endpoint])) return;
      const data = await api(cfg.endpoint);
      const arr = Array.isArray(data) ? data : [];
      state.managerAdmin.records[cfg.endpoint] = arr;
      if (cfg.endpoint === '/api/groups/') state.managerAdmin.refs.groups = arr;
      if (cfg.endpoint === '/api/parents/') state.managerAdmin.refs.parents = arr;
    }

    function managerFilteredRecords() {
      const cfg = managerCurrentCfg();
      const records = Array.isArray(state.managerAdmin.records[cfg.endpoint]) ? state.managerAdmin.records[cfg.endpoint] : [];
      const q = String(($('manager-admin-search') && $('manager-admin-search').value) || '').trim().toLowerCase();
      const filterVal = String(($('manager-admin-filter') && $('manager-admin-filter').value) || '');
      return records.filter((r) => {
        if (q) {
          const hay = JSON.stringify(r || {}).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        if (cfg.filterType === 'groups' && filterVal) {
          if (String(r.group || '') !== filterVal && !(Array.isArray(r.groups) && r.groups.map(String).includes(filterVal))) return false;
        }
        if (cfg.filterType === 'groupsPlusGlobal' && filterVal) {
          if (filterVal === 'global') return !r.group;
          if (String(r.group || '') !== filterVal) return false;
        }
        return true;
      });
    }

    function managerSetActiveTab(tab) {
      state.managerAdmin.tab = tab;
      portalSafeSet(portalKey('manager_admin_tab'), tab);
      state.managerAdmin.selectedId = null;
      document.querySelectorAll('.manager-admin-nav-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.managerTab === tab);
      });
      managerRenderToolbar();
      managerRenderList();
      managerRenderForm(null);
      managerRefreshData().catch((e) => {
        $('manager-admin-list-status').textContent = e.message;
      });
    }

    function managerRenderToolbar() {
      const cfg = managerCurrentCfg();
      if (!cfg) return;
      $('manager-admin-create').textContent = `–°–æ–∑–¥–∞—Ç—å: ${cfg.title}`;
      const search = $('manager-admin-search');
      const filter = $('manager-admin-filter');
      search.value = managerStorageGetSearch();
      filter.innerHTML = '';
      if (cfg.filterType === 'groups' || cfg.filterType === 'groupsPlusGlobal') {
        const opts = managerRefOptions('groups');
        const first = document.createElement('option');
        first.value = '';
        first.textContent = cfg.filterLabel || '–í—Å–µ';
        filter.appendChild(first);
        if (cfg.filterType === 'groupsPlusGlobal') {
          const og = document.createElement('option');
          og.value = 'global';
          og.textContent = '–í—Å–µ –≥—Ä—É–ø–ø—ã (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)';
          filter.appendChild(og);
        }
        opts.forEach((o) => {
          const opt = document.createElement('option');
          opt.value = String(o.value);
          opt.textContent = o.label;
          filter.appendChild(opt);
        });
        filter.style.display = '';
        filter.value = managerStorageGetFilter();
      } else {
        filter.style.display = 'none';
      }
    }

    function managerRecordId(r) { return Number(r && r.id ? r.id : 0); }

    function managerCreateModelForTab(tab) {
      const map = {
        groups: 'groups',
        students: 'students',
        parents: 'parents',
        teachers: 'teachers',
        schedule: 'schedule',
        holidays: 'holidays',
      };
      return map[tab] || null;
    }

    function managerRenderList() {
      const cfg = managerCurrentCfg();
      const list = $('manager-admin-list');
      const statusEl = $('manager-admin-list-status');
      if (!cfg) {
        list.innerHTML = '<div class="empty">–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>';
        return;
      }
      const items = managerFilteredRecords();
      statusEl.textContent = `${cfg.title}: ${items.length}`;
      if (!items.length) {
        list.innerHTML = '<div class="empty">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
        return;
      }
      if (!items.some((x) => managerRecordId(x) === Number(state.managerAdmin.selectedId))) {
        state.managerAdmin.selectedId = managerRecordId(items[0]);
      }
      list.innerHTML = items.map((r) => `
        <div class="manager-admin-item${managerRecordId(r) === Number(state.managerAdmin.selectedId) ? ' active' : ''}" data-id="${managerRecordId(r)}">
          <div class="manager-admin-item-title">${esc(cfg.columnsLabel(r))}</div>
          <div class="manager-admin-item-meta">${esc(cfg.meta(r) || '')}</div>
        </div>
      `).join('');
      list.querySelectorAll('[data-id]').forEach((el) => {
        el.onclick = () => {
          state.managerAdmin.selectedId = Number(el.dataset.id);
          managerRenderList();
          const rec = (state.managerAdmin.records[cfg.endpoint] || []).find((x) => managerRecordId(x) === state.managerAdmin.selectedId) || null;
          managerRenderForm(rec);
        };
      });
    }

    function managerFormFieldHtml(field) {
      const id = `mgr-field-${field.key}`;
      const cls = field.full ? 'full' : '';
      if (field.type === 'textarea') {
        return `<div class="${cls}"><label for="${id}">${field.label}</label><textarea id="${id}" name="${field.key}" ${field.required ? 'required' : ''}></textarea></div>`;
      }
      if (field.type === 'multiselect') {
        return `<div class="${cls}"><label for="${id}">${field.label}</label><select id="${id}" name="${field.key}" multiple></select><div class="hint">Ctrl/Cmd –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</div></div>`;
      }
      if (field.type === 'select' || field.type === 'selectOptional' || field.type === 'selectStatic') {
        return `<div class="${cls}"><label for="${id}">${field.label}</label><select id="${id}" name="${field.key}" ${field.required ? 'required' : ''}></select></div>`;
      }
      const type = field.type === 'number' || field.type === 'date' || field.type === 'time' || field.type === 'email' || field.type === 'url' ? field.type : 'text';
      return `<div class="${cls}"><label for="${id}">${field.label}</label><input id="${id}" name="${field.key}" type="${type}" ${field.required ? 'required' : ''} ${field.min != null ? `min="${field.min}"` : ''} ${field.max != null ? `max="${field.max}"` : ''}></div>`;
    }

    function managerBindFieldOptions(cfg, record = null) {
      cfg.fields.forEach((field) => {
        if (!(field.type === 'select' || field.type === 'selectOptional' || field.type === 'multiselect' || field.type === 'selectStatic')) return;
        const el = $(`mgr-field-${field.key}`);
        if (!el) return;
        let opts = [];
        if (field.type === 'selectStatic') {
          opts = (field.choices || []).map(([value, label]) => ({ value, label }));
        } else {
          opts = managerRefOptions(field.options);
        }
        el.innerHTML = '';
        if (field.type === 'selectOptional') {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
          el.appendChild(opt);
        }
        if (field.type === 'select') {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ...';
          el.appendChild(opt);
        }
        opts.forEach((o) => {
          const opt = document.createElement('option');
          opt.value = String(o.value);
          opt.textContent = o.label;
          el.appendChild(opt);
        });
        if (!record) return;
        if (field.type === 'multiselect') {
          let rawValues = record[field.key];
          if (cfg.endpoint === '/api/groups/' && field.key === 'student_ids') rawValues = Array.isArray(record.students) ? record.students.map((s) => s.id) : [];
          const values = Array.isArray(rawValues) ? rawValues.map(String) : [];
          Array.from(el.options).forEach((opt) => { opt.selected = values.includes(opt.value); });
        } else if (record[field.key] != null) {
          el.value = String(record[field.key]);
        }
      });
    }

    function managerPrefillForm(cfg, record = null) {
      cfg.fields.forEach((field) => {
        const el = $(`mgr-field-${field.key}`);
        if (!el) return;
        if (field.type === 'multiselect' || field.type === 'select' || field.type === 'selectOptional' || field.type === 'selectStatic') return;
        if (record && record[field.key] != null) {
          el.value = String(record[field.key]);
        } else if (field.default != null) {
          el.value = String(field.default);
        } else {
          el.value = '';
        }
      });
    }

    function managerRenderForm(record = null) {
      const cfg = managerCurrentCfg();
      const wrap = $('manager-admin-form-wrap');
      if (!cfg) {
        wrap.innerHTML = '<div class="empty">–ù–µ—Ç —Ñ–æ—Ä–º—ã</div>';
        return;
      }
      const createModel = managerCreateModelForTab(state.managerAdmin.tab);
      if (createModel) {
        const title = esc(cfg.formTitle(record));
        const idParam = record && record.id ? `?id=${encodeURIComponent(record.id)}&embedded=1` : '?embedded=1';
        const src = `/manager/create/${createModel}/${idParam}`;
        const groupStudentsPanel = (state.managerAdmin.tab === 'groups' && record && record.id) ? `
          <div class="manager-admin-form" style="margin-top:12px;">
            <div class="manager-admin-form-head">
              <h4>–£—á–µ–Ω–∏–∫–∏ –≤ –≥—Ä—É–ø–ø–µ</h4>
            </div>
            <div class="manager-admin-form-grid">
              <div class="full">
                <label for="manager-group-students-select">–°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)</label>
                <select id="manager-group-students-select" multiple></select>
                <div class="hint">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ. –ß—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —É—á–µ–Ω–∏–∫–∞, –ø–æ–º–µ–Ω—è–π—Ç–µ –µ–º—É –≥—Ä—É–ø–ø—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "–£—á–µ–Ω–∏–∫–∏".</div>
              </div>
            </div>
            <div class="manager-admin-form-actions">
              <button id="manager-group-students-save" class="manager-link-btn primary" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–∞–≤</button>
            </div>
            <div id="manager-group-students-status" class="manager-inline-status"></div>
          </div>
        ` : '';
        wrap.innerHTML = `
          <div class="manager-admin-form-head">
            <h4>${title}</h4>
            <div class="manager-card-actions">
              ${record ? '<button id="manager-admin-delete" class="manager-link-btn danger" type="button">üóë –£–¥–∞–ª–∏—Ç—å</button>' : ''}
              <button id="manager-admin-new" class="manager-link-btn" type="button">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
            </div>
          </div>
          <iframe class="manager-admin-form-embed" id="manager-admin-form-iframe" src="${src}" loading="lazy"></iframe>
          <div id="manager-admin-form-status" class="manager-inline-status"></div>
          ${groupStudentsPanel}
        `;
        $('manager-admin-new').onclick = () => {
          state.managerAdmin.selectedId = null;
          managerRenderList();
          managerRenderForm(null);
        };
        if (record && $('manager-admin-delete')) {
          $('manager-admin-delete').onclick = () => managerDeleteRecord(record);
        }
        if (state.managerAdmin.tab === 'groups' && record && record.id) {
          const select = $('manager-group-students-select');
          const allStudents = state.managerAdmin.refs.students || [];
          const currentIds = new Set(Array.isArray(record.students) ? record.students.map((s) => Number(s.id)) : []);
          select.innerHTML = allStudents.map((s) => {
            const full = `${s.last_name || ''} ${s.first_name || ''}`.trim() || `–£—á–µ–Ω–∏–∫ ${s.id}`;
            const suffix = s.group_name ? ` ¬∑ ${s.group_name}` : '';
            return `<option value="${s.id}"${currentIds.has(Number(s.id)) ? ' selected' : ''}>${esc(full + suffix)}</option>`;
          }).join('');
          $('manager-group-students-save').onclick = async () => {
            const status = $('manager-group-students-status');
            status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞...';
            try {
              const selectedIds = Array.from(select.selectedOptions).map((o) => Number(o.value));
              await managerSyncGroupStudents(record.id, selectedIds, record);
              await managerEnsureRefs();
              await managerLoadRecords(true);
              const fresh = (state.managerAdmin.records[cfg.endpoint] || []).find((x) => Number(x.id) === Number(record.id)) || record;
              state.groups = (state.managerAdmin.refs.groups || []).map((g) => ({
                id: g.id,
                name: g.name || `–ì—Ä—É–ø–ø–∞ ${g.id}`,
                students_count: Array.isArray(g.students) ? g.students.length : 0,
                parents_count: Array.isArray(g.students)
                  ? new Set(g.students.flatMap((s) => Array.isArray(s.parents) ? s.parents : [])).size
                  : 0,
              }));
              renderClasses();
              renderRooms();
              managerRenderList();
              managerRenderForm(fresh);
              status.textContent = '–°–æ—Å—Ç–∞–≤ –æ–±–Ω–æ–≤–ª–µ–Ω.';
            } catch (e) {
              status.textContent = e.message;
            }
          };
        }
        return;
      }
      wrap.innerHTML = `
        <div class="manager-admin-form-head">
          <h4>${esc(cfg.formTitle(record))}</h4>
          <div class="manager-card-actions">
            ${record ? '<button id="manager-admin-delete" class="manager-link-btn danger" type="button">üóë –£–¥–∞–ª–∏—Ç—å</button>' : ''}
            <button id="manager-admin-new" class="manager-link-btn" type="button">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
          </div>
        </div>
        <form id="manager-admin-form">
          <input type="hidden" name="id" value="${record ? record.id : ''}">
          <div class="manager-admin-form-grid">
            ${cfg.fields.map(managerFormFieldHtml).join('')}
          </div>
          <div class="manager-admin-form-actions">
            <button id="manager-admin-save" class="manager-link-btn primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div id="manager-admin-form-status" class="manager-inline-status"></div>
        </form>
      `;
      managerBindFieldOptions(cfg, record);
      managerPrefillForm(cfg, record);
      cfg.fields.forEach((field) => {
        if (!field.mediaUpload) return;
        const row = document.getElementById(`mgr-field-${field.key}`)?.parentElement;
        if (!row) return;
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = (field.key === 'media_url') ? 'image/*,video/*' : '*/*';
        fileInput.style.marginTop = '8px';
        const uploadBtn = document.createElement('button');
        uploadBtn.type = 'button';
        uploadBtn.className = 'manager-link-btn';
        uploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª';
        uploadBtn.style.marginTop = '8px';
        uploadBtn.onclick = async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          const statusEl = $('manager-admin-form-status');
          statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...';
          try {
            const url = await uploadMedia(file);
            const target = $(`mgr-field-${field.key}`);
            if (target) target.value = url;
            statusEl.textContent = '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω.';
          } catch (e) {
            statusEl.textContent = e.message;
          }
        };
        row.appendChild(fileInput);
        row.appendChild(uploadBtn);
      });

      $('manager-admin-new').onclick = () => {
        state.managerAdmin.selectedId = null;
        managerRenderList();
        managerRenderForm(null);
      };
      if (record && $('manager-admin-delete')) {
        $('manager-admin-delete').onclick = () => managerDeleteRecord(record);
      }
      $('manager-admin-form').onsubmit = (e) => {
        e.preventDefault();
        managerSaveForm(record);
      };
    }

    function managerCollectForm(cfg, record = null) {
      const data = {};
      cfg.fields.forEach((field) => {
        const el = $(`mgr-field-${field.key}`);
        if (!el) return;
        if (field.type === 'multiselect') {
          data[field.key] = Array.from(el.selectedOptions).map((o) => Number(o.value));
          return;
        }
        let value = el.value;
        if (field.type === 'select' || field.type === 'selectOptional') {
          if (value === '' && field.type === 'selectOptional') data[field.key] = null;
          else if (value === '') data[field.key] = '';
          else data[field.key] = Number.isFinite(Number(value)) && /^[0-9]+$/.test(String(value)) ? Number(value) : value;
          return;
        }
        if (field.type === 'selectStatic') {
          data[field.key] = value || '';
          return;
        }
        if (field.type === 'number') {
          data[field.key] = value === '' ? null : Number(value);
          return;
        }
        data[field.key] = value || '';
      });

      if (cfg.endpoint === '/api/holidays/' && !data.title) data.title = '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å';
      if (cfg.endpoint === '/api/schedule/') {
        if (!record) {
          delete data.method_package_id;
          delete data.apply_from_lesson_number;
          delete data.duration_minutes;
          if (!data.occurrences_count) data.occurrences_count = 6;
          if (!data.start_method_number) data.start_method_number = 1;
          if (!data.lesson_number) data.lesson_number = 1;
        } else {
          if (data.subject_id == null || data.subject_id === '') delete data.subject_id;
          if (data.start_method_number == null) delete data.start_method_number;
          if (data.occurrences_count != null) delete data.occurrences_count;
          if (data.method_package_id == null || data.method_package_id === '') delete data.method_package_id;
          if (!data.apply_from_lesson_number) delete data.apply_from_lesson_number;
        }
      }
      return data;
    }

    async function managerSyncGroupStudents(groupId, selectedStudentIds, currentGroupRecord) {
      const selected = new Set((selectedStudentIds || []).map(Number));
      const current = new Set(Array.isArray(currentGroupRecord?.students) ? currentGroupRecord.students.map((s) => Number(s.id)) : []);
      const toMove = [...selected].filter((id) => !current.has(id));
      if (!toMove.length) return { moved: 0 };
      const allStudents = state.managerAdmin.refs.students || [];
      for (const sid of toMove) {
        const st = allStudents.find((s) => Number(s.id) === Number(sid));
        if (!st) continue;
        const payload = {
          last_name: st.last_name || '',
          first_name: st.first_name || '',
          notes: st.notes || '',
          group: Number(groupId),
          parents: Array.isArray(st.parents) ? st.parents : [],
        };
        await api(`/api/students/${sid}/`, 'PUT', payload);
      }
      state.managerAdmin.refs.students = await api('/api/students/');
      return { moved: toMove.length };
    }

    async function managerSaveForm(record = null) {
      const cfg = managerCurrentCfg();
      const formEl = $('manager-admin-form');
      if (!formEl || !formEl.reportValidity()) return;
      const statusEl = $('manager-admin-form-status');
      statusEl.textContent = record ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...' : '–°–æ–∑–¥–∞–Ω–∏–µ...';
      try {
        const payload = managerCollectForm(cfg, record);
        let resp;
        const extraStudentIds = (cfg.endpoint === '/api/groups/') ? (Array.isArray(payload.student_ids) ? payload.student_ids.slice() : []) : [];
        if (cfg.endpoint === '/api/groups/') delete payload.student_ids;
        if (record && record.id) {
          resp = await api(`${cfg.endpoint}${record.id}/`, 'PUT', payload);
        } else {
          resp = await api(cfg.endpoint, 'POST', payload);
        }
        if (cfg.endpoint === '/api/groups/' && resp && resp.id) {
          const syncInfo = await managerSyncGroupStudents(resp.id, extraStudentIds, record || null);
          if (syncInfo && syncInfo.moved) {
            // no-op, message set below
          }
        }
        await managerEnsureRefs();
        await managerLoadRecords(true);
        if (cfg.endpoint === '/api/groups/' || cfg.endpoint === '/api/parents/') {
          await managerEnsureRefs();
        }
        if (cfg.endpoint === '/api/groups/') {
          state.groups = (state.managerAdmin.refs.groups || []).map((g) => ({
            id: g.id,
            name: g.name || `–ì—Ä—É–ø–ø–∞ ${g.id}`,
            students_count: Array.isArray(g.students) ? g.students.length : 0,
            parents_count: Array.isArray(g.students)
              ? new Set(g.students.flatMap((s) => Array.isArray(s.parents) ? s.parents : [])).size
              : 0,
          }));
          if (!state.groups.some((g) => Number(g.id) === Number(state.activeGroupId))) {
            state.activeGroupId = state.groups[0] ? state.groups[0].id : null;
          }
          renderClasses();
          renderRooms();
        }
        state.managerAdmin.selectedId = Array.isArray(resp) ? null : (resp && resp.id ? resp.id : state.managerAdmin.selectedId);
        managerRenderToolbar();
        managerRenderList();
        const items = state.managerAdmin.records[cfg.endpoint] || [];
        const selected = items.find((x) => managerRecordId(x) === Number(state.managerAdmin.selectedId)) || null;
        managerRenderForm(selected);
        $('manager-admin-form-status').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
      } catch (e) {
        statusEl.textContent = e.message;
      }
    }

    async function managerDeleteRecord(record) {
      const cfg = managerCurrentCfg();
      if (!record || !record.id) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      const statusEl = $('manager-admin-form-status');
      if (statusEl) statusEl.textContent = '–£–¥–∞–ª–µ–Ω–∏–µ...';
      try {
        await api(`${cfg.endpoint}${record.id}/`, 'DELETE');
        state.managerAdmin.selectedId = null;
        await managerLoadRecords(true);
        managerRenderList();
        managerRenderForm(null);
      } catch (e) {
        if (statusEl) statusEl.textContent = e.message;
      }
    }

    async function managerRefreshData() {
      await managerEnsureRefs();
      await managerLoadRecords(true);
      managerRenderToolbar();
      managerRenderList();
      const cfg = managerCurrentCfg();
      const items = state.managerAdmin.records[cfg.endpoint] || [];
      const selected = items.find((x) => managerRecordId(x) === Number(state.managerAdmin.selectedId)) || null;
      managerRenderForm(selected);
    }

    async function initManagerAdmin() {
      try {
        if (state.token) localStorage.setItem('consoleAccessToken', state.token);
      } catch (_) {}
      const savedManagerTab = String(portalSafeGet(portalKey('manager_admin_tab')) || '').trim();
      if (savedManagerTab && MANAGER_CFG[savedManagerTab]) state.managerAdmin.tab = savedManagerTab;
      window.addEventListener('message', async (event) => {
        if (event.origin !== window.location.origin) return;
        const msg = event.data || {};
        if (msg.type !== 'consoleCreateSaved') return;
        const currentModel = managerCreateModelForTab(state.managerAdmin.tab);
        if (!currentModel || msg.model !== currentModel) return;
        try {
          const cfg = managerCurrentCfg();
          await managerLoadRecords(true);
          if (msg.id) state.managerAdmin.selectedId = Number(msg.id);
          managerRenderToolbar();
          managerRenderList();
          const items = (cfg && state.managerAdmin.records[cfg.endpoint]) || [];
          const selected = items.find((x) => managerRecordId(x) === Number(state.managerAdmin.selectedId)) || null;
          managerRenderForm(selected);
          const status = $('manager-admin-form-status');
          if (status) status.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.';
          if (state.managerAdmin.tab === 'groups') {
            state.managerAdmin.refs.groups = await api('/api/groups/');
            state.groups = (state.managerAdmin.refs.groups || []).map((g) => ({
              id: g.id,
              name: g.name || `–ì—Ä—É–ø–ø–∞ ${g.id}`,
              students_count: Array.isArray(g.students) ? g.students.length : 0,
              parents_count: Array.isArray(g.students)
                ? new Set(g.students.flatMap((s) => Array.isArray(s.parents) ? s.parents : [])).size
                : 0,
            }));
            renderClasses();
            renderRooms();
          }
        } catch (e) {
          const status = $('manager-admin-form-status');
          if (status) status.textContent = e.message;
        }
      });
      document.querySelectorAll('.manager-admin-nav-btn').forEach((btn) => {
        btn.onclick = () => managerSetActiveTab(btn.dataset.managerTab);
      });
      $('manager-admin-search').addEventListener('input', () => {
        managerStorageSetSearch($('manager-admin-search').value);
        managerRenderList();
      });
      $('manager-admin-filter').addEventListener('change', () => {
        managerStorageSetFilter($('manager-admin-filter').value);
        managerRenderList();
      });
      $('manager-admin-create').onclick = () => {
        state.managerAdmin.selectedId = null;
        managerRenderList();
        managerRenderForm(null);
      };
      managerSetActiveTab(state.managerAdmin.tab || 'groups');
    }

    function toEmbedUrl(url) {
      if (!url) return null;
      const clean = String(url).trim();
      if (clean.includes('youtube.com/watch?v=')) {
        const id = clean.split('v=')[1].split('&')[0];
        return `https://www.youtube.com/embed/${id}`;
      }
      if (clean.includes('youtu.be/')) {
        const id = clean.split('youtu.be/')[1].split('?')[0];
        return `https://www.youtube.com/embed/${id}`;
      }
      return null;
    }

    function normalizeBlockStyle(style, type) {
      const s = style || {};
      return {
        textColor: String(s.textColor || (type === 'quote' ? '#27334d' : '#1d2433')),
        fontSize: Number(s.fontSize || (type === 'heading' ? 30 : 16)),
        textAlign: String(s.textAlign || 'left'),
        maxWidth: Number(s.maxWidth || 100),
        radius: Number(s.radius || 10),
        bgColor: String(s.bgColor || (type === 'quote' ? '#eaf0ff' : 'transparent')),
        captionColor: String(s.captionColor || '#66758f'),
        captionSize: Number(s.captionSize || 12),
      };
    }

    function renderMethodBlocks(container, methodObj, doc = document) {
      const blocks = Array.isArray(methodObj.content_blocks) ? methodObj.content_blocks : [];
      if (!blocks.length) {
        const empty = doc.createElement('div');
        empty.className = 'live-desc';
        empty.textContent = '–î–ª—è —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–ø–∞–∫–µ—Ç–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –±–ª–æ–∫–∏.';
        container.appendChild(empty);
        return;
      }
      blocks.forEach((b) => {
        const box = doc.createElement('div');
        box.className = 'live-block method-block';
        const style = normalizeBlockStyle(b.style, b.type);
        box.style.textAlign = style.textAlign;
        if (b.type === 'heading' && b.text) {
          const h = doc.createElement('h3');
          h.textContent = b.text;
          h.style.color = style.textColor;
          h.style.fontSize = `${style.fontSize}px`;
          box.appendChild(h);
        }
        if (b.type === 'text' && b.text) {
          const p = doc.createElement('p');
          p.textContent = b.text;
          p.style.color = style.textColor;
          p.style.fontSize = `${style.fontSize}px`;
          p.style.lineHeight = '1.6';
          box.appendChild(p);
        }
        if (b.type === 'quote' && b.text) {
          const q = doc.createElement('div');
          q.className = 'live-quote method-quote';
          q.textContent = b.text;
          q.style.color = style.textColor;
          q.style.fontSize = `${style.fontSize}px`;
          q.style.background = style.bgColor;
          box.appendChild(q);
        }
        if (b.type === 'image' && b.url) {
          const img = doc.createElement('img');
          img.src = b.url;
          img.alt = b.caption || 'image';
          img.style.maxWidth = `${style.maxWidth}%`;
          img.style.borderRadius = `${style.radius}px`;
          if (style.textAlign === 'center') img.style.margin = '0 auto';
          if (style.textAlign === 'right') img.style.margin = '0 0 0 auto';
          box.appendChild(img);
          if (b.caption) {
            const cap = doc.createElement('div');
            cap.className = 'live-caption method-cap';
            cap.textContent = b.caption;
            cap.style.color = style.captionColor;
            cap.style.fontSize = `${style.captionSize}px`;
            box.appendChild(cap);
          }
        }
        if (b.type === 'video' && b.url) {
          const embed = toEmbedUrl(b.url);
          if (embed) {
            const iframe = doc.createElement('iframe');
            iframe.src = embed;
            iframe.allowFullscreen = true;
            iframe.style.maxWidth = `${style.maxWidth}%`;
            iframe.style.borderRadius = `${style.radius}px`;
            if (style.textAlign === 'center') iframe.style.margin = '0 auto';
            if (style.textAlign === 'right') iframe.style.margin = '0 0 0 auto';
            box.appendChild(iframe);
          } else {
            const link = doc.createElement('a');
            link.href = b.url;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = '–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ';
            link.className = 'method-btn';
            box.appendChild(link);
          }
          if (b.caption) {
            const cap = doc.createElement('div');
            cap.className = 'live-caption method-cap';
            cap.textContent = b.caption;
            cap.style.color = style.captionColor;
            cap.style.fontSize = `${style.captionSize}px`;
            box.appendChild(cap);
          }
        }
        container.appendChild(box);
      });
    }

    function renderMethodLivePage(container, methodObj, doc = document) {
      const page = doc.createElement('div');
      page.className = 'live-page';

      const header = doc.createElement('div');
      header.className = 'live-header';
      header.innerHTML = `<div class="live-badge">–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç</div><h2 class="live-title">${esc(methodObj.title || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞')}</h2>`;
      page.appendChild(header);

      const meta = doc.createElement('div');
      meta.className = 'live-desc';
      meta.textContent = `${methodObj.subject_name || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞'} ¬∑ –ú–µ—Ç–æ–¥ ${Number(methodObj.method_number || 0) || '‚Äî'}`;
      page.appendChild(meta);

      if (methodObj.description) {
        const d = doc.createElement('div');
        d.className = 'live-desc';
        d.textContent = methodObj.description;
        page.appendChild(d);
      }

      if (methodObj.material_url) {
        const aWrap = doc.createElement('div');
        aWrap.style.textAlign = 'center';
        const a = doc.createElement('a');
        a.className = 'live-material-link';
        a.href = methodObj.material_url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã';
        aWrap.appendChild(a);
        page.appendChild(aWrap);
      }

      renderMethodBlocks(page, methodObj, doc);
      container.appendChild(page);
    }

    function formatDateRu(dateStr) {
      if (!dateStr) return '–ë–µ–∑ –¥–∞—Ç—ã';
      const d = new Date(`${String(dateStr).slice(0, 10)}T00:00:00`);
      if (Number.isNaN(d.getTime())) return String(dateStr);
      return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function formatDateTimeRu(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return String(dateStr);
      return d.toLocaleString('ru-RU', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit',
      });
    }

    function currentManagerGroup() {
      return state.groups.find((g) => Number(g.id) === Number(state.activeGroupId)) || null;
    }

    function managerSocialMediaHtml(item) {
      const mediaType = String(item.media_type || 'none');
      const mediaUrl = String(item.media_url || '').trim();
      if (!mediaUrl || mediaType === 'none') return '';
      if (mediaType === 'image') {
        return `<div class="manager-social-media"><img src="${esc(mediaUrl)}" alt="media"></div>`;
      }
      if (mediaType === 'video') {
        const embed = toEmbedUrl(mediaUrl);
        if (embed) {
          return `<div class="manager-social-media"><iframe src="${esc(embed)}" allowfullscreen></iframe></div>`;
        }
        return `<div class="manager-social-media"><video controls src="${esc(mediaUrl)}"></video></div>`;
      }
      return '';
    }

    function managerSocialKindMeta(kind) {
      if (kind === 'events') {
        return {
          endpoint: '/api/events/',
          paneId: 'manager-events-pane',
          listStateKey: 'managerEvents',
          editStateKey: 'managerEventEditId',
          composeStateKey: 'managerEventComposeOpen',
          title: '–°–æ–±—ã—Ç–∏—è',
          emptyText: '–°–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–∫–∞ –Ω–µ—Ç.',
          createLabel: '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ',
          saveLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ',
          fields: [
            { key: 'title', label: '–ó–∞–≥–æ–ª–æ–≤–æ–∫', type: 'text', required: true },
            { key: 'event_date', label: '–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è', type: 'date' },
            { key: 'media_type', label: '–ú–µ–¥–∏–∞', type: 'selectStatic', choices: [['none', '–ë–µ–∑ –º–µ–¥–∏–∞'], ['image', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'], ['video', '–í–∏–¥–µ–æ']] },
            { key: 'media_url', label: '–°—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–¥–∏–∞', type: 'url' },
            { key: 'description', label: '–û–ø–∏—Å–∞–Ω–∏–µ', type: 'textarea', full: true, required: true },
          ],
          normalizePayload(payload) {
            if (!payload.event_date) payload.event_date = null;
            if (!payload.media_type || payload.media_type === 'none') {
              payload.media_type = 'none';
              payload.media_url = '';
            }
            return payload;
          },
          cardTitle(item) { return item.title || '–°–æ–±—ã—Ç–∏–µ'; },
          cardDate(item) { return item.event_date ? `–î–∞—Ç–∞: ${formatDateRu(item.event_date)}` : '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'; },
          cardMeta(item) { return `–°–æ–∑–¥–∞–Ω–æ: ${formatDateTimeRu(item.created_at)}`; },
          cardText(item) { return item.description || ''; },
          prefill(record) {
            return {
              title: record?.title || '',
              event_date: record?.event_date || '',
              media_type: record?.media_type || 'none',
              media_url: record?.media_url || '',
              description: record?.description || '',
            };
          },
        };
      }
      return {
        endpoint: '/api/feed-posts/',
        paneId: 'manager-feed-pane',
        listStateKey: 'managerFeed',
        editStateKey: 'managerFeedEditId',
        composeStateKey: 'managerFeedComposeOpen',
        title: '–õ–µ–Ω—Ç–∞',
        emptyText: '–ó–∞–ø–∏—Å–µ–π –≤ –ª–µ–Ω—Ç–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–∫–∞ –Ω–µ—Ç.',
        createLabel: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç',
        saveLabel: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç',
        fields: [
          { key: 'author_name', label: '–ê–≤—Ç–æ—Ä', type: 'text', required: true },
          { key: 'media_type', label: '–ú–µ–¥–∏–∞', type: 'selectStatic', choices: [['none', '–ë–µ–∑ –º–µ–¥–∏–∞'], ['image', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'], ['video', '–í–∏–¥–µ–æ']] },
          { key: 'media_url', label: '–°—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–¥–∏–∞', type: 'url' },
          { key: 'text', label: '–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', type: 'textarea', full: true, required: true },
        ],
        normalizePayload(payload) {
          if (!payload.author_name) payload.author_name = state.myDisplayName || (state.me?.username || '–ú–µ–Ω–µ–¥–∂–µ—Ä');
          if (!payload.media_type || payload.media_type === 'none') {
            payload.media_type = 'none';
            payload.media_url = '';
          }
          return payload;
        },
        cardTitle(item) { return item.author_name || '–ú–µ–Ω–µ–¥–∂–µ—Ä'; },
        cardDate(item) { return formatDateTimeRu(item.created_at); },
        cardMeta() { return ''; },
        cardText(item) { return item.text || ''; },
        prefill(record) {
          return {
            author_name: record?.author_name || state.myDisplayName || (state.me?.username || '–ú–µ–Ω–µ–¥–∂–µ—Ä'),
            media_type: record?.media_type || 'none',
            media_url: record?.media_url || '',
            text: record?.text || '',
          };
        },
      };
    }

    function managerSocialFieldHtml(kind, field, values) {
      const id = `mgr-${kind}-${field.key}`;
      const cls = field.full ? 'full' : '';
      const rawValue = values && values[field.key] != null ? values[field.key] : '';
      const value = String(rawValue || '');
      if (field.type === 'textarea') {
        return `
          <div class="${cls}">
            <label for="${id}">${esc(field.label)}</label>
            <textarea id="${id}" ${field.required ? 'required' : ''}>${esc(value)}</textarea>
          </div>
        `;
      }
      if (field.type === 'selectStatic') {
        const options = (field.choices || []).map(([v, label]) =>
          `<option value="${esc(v)}"${String(v) === value ? ' selected' : ''}>${esc(label)}</option>`
        ).join('');
        return `
          <div class="${cls}">
            <label for="${id}">${esc(field.label)}</label>
            <select id="${id}">${options}</select>
          </div>
        `;
      }
      const type = field.type || 'text';
      return `
        <div class="${cls}">
          <label for="${id}">${esc(field.label)}</label>
          <input id="${id}" type="${esc(type)}" value="${esc(value)}" ${field.required ? 'required' : ''}>
        </div>
      `;
    }

    function managerSocialCollect(kind) {
      const meta = managerSocialKindMeta(kind);
      const payload = { group: Number(state.activeGroupId) };
      meta.fields.forEach((field) => {
        const el = $(`mgr-${kind}-${field.key}`);
        if (!el) return;
        payload[field.key] = (field.type === 'textarea') ? el.value : String(el.value || '');
      });
      return meta.normalizePayload(payload);
    }

    function managerSocialSetStatus(kind, text) {
      const el = $(`mgr-${kind}-status`);
      if (el) el.textContent = text || '';
    }

    function managerSocialBindMedia(kind) {
      const fileInput = $(`mgr-${kind}-media-file`);
      const uploadBtn = $(`mgr-${kind}-media-upload`);
      if (!fileInput || !uploadBtn) return;
      uploadBtn.onclick = async () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          managerSocialSetStatus(kind, '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
          return;
        }
        managerSocialSetStatus(kind, '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
        try {
          const url = await uploadMedia(file);
          const urlInput = $(`mgr-${kind}-media_url`);
          const mediaTypeSelect = $(`mgr-${kind}-media_type`);
          if (urlInput) urlInput.value = url;
          if (mediaTypeSelect && mediaTypeSelect.value === 'none') {
            const isVideo = (file.type || '').startsWith('video/');
            mediaTypeSelect.value = isVideo ? 'video' : 'image';
          }
          managerSocialSetStatus(kind, '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω.');
        } catch (e) {
          managerSocialSetStatus(kind, e.message);
        }
      };
    }

    function managerRenderSocialPane(kind) {
      const meta = managerSocialKindMeta(kind);
      const pane = $(meta.paneId);
      if (!pane) return;
      const currentGroup = currentManagerGroup();
      if (!currentGroup) {
        pane.innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –≤ —á–∞—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å —ç—Ç–∏–º —Ä–∞–∑–¥–µ–ª–æ–º.</div>';
        return;
      }
      const list = Array.isArray(state[meta.listStateKey]) ? state[meta.listStateKey] : [];
      const editId = Number(state[meta.editStateKey] || 0);
      const editing = list.find((x) => Number(x.id) === editId) || null;
      const composeOpen = Boolean(state[meta.composeStateKey]) || Boolean(editing);
      const values = meta.prefill(editing);
      pane.innerHTML = `
        <div class="manager-social-topbar">
          <div>
            <h4>${esc(meta.title)}</h4>
            <div class="sub">–ì—Ä—É–ø–ø–∞: ${esc(currentGroup.name)}</div>
          </div>
          <button class="manager-plus-btn" id="mgr-${kind}-toggle-compose" type="button" title="–î–æ–±–∞–≤–∏—Ç—å">+</button>
        </div>
        ${composeOpen ? `
          <div class="manager-social-compose">
            <h4>${editing ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${esc(meta.title.toLowerCase())}` : meta.createLabel}</h4>
            <form id="mgr-${kind}-form">
              <input id="mgr-${kind}-edit-id" type="hidden" value="${editing ? editing.id : ''}">
              <div class="manager-social-grid">
                ${meta.fields.map((field) => managerSocialFieldHtml(kind, field, values)).join('')}
              </div>
              <div class="manager-social-file">
                <input id="mgr-${kind}-media-file" type="file" accept="image/*,video/*">
                <button id="mgr-${kind}-media-upload" class="manager-link-btn" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                ${values.media_url ? `<a class="manager-social-inline-link" href="${esc(values.media_url)}" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞</a>` : ''}
              </div>
              <div class="manager-social-actions">
                <button class="manager-link-btn primary" type="submit">${editing ? meta.saveLabel : meta.createLabel}</button>
                <button id="mgr-${kind}-cancel" class="manager-link-btn" type="button">${editing ? '–û—Ç–º–µ–Ω–∞' : '–°–≤–µ—Ä–Ω—É—Ç—å'}</button>
              </div>
              <div id="mgr-${kind}-status" class="manager-social-status"></div>
            </form>
          </div>
        ` : ''}
        <div class="manager-social-list">
          ${list.length ? list.map((item) => {
            const isEdit = Number(item.id) === editId;
            const metaText = meta.cardMeta(item);
            return `
              <div class="manager-social-card${isEdit ? ' active' : ''}">
                <div class="manager-social-head">
                  <div class="manager-social-title">${esc(meta.cardTitle(item))}</div>
                  <div class="manager-social-date">${esc(meta.cardDate(item))}</div>
                </div>
                ${metaText ? `<div class="manager-social-meta">${esc(metaText)}</div>` : ''}
                <div class="manager-social-text">${esc(meta.cardText(item))}</div>
                ${managerSocialMediaHtml(item)}
                <div class="manager-social-card-actions">
                  <button class="manager-link-btn" type="button" data-social-edit="${kind}" data-id="${item.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="manager-link-btn" type="button" data-social-del="${kind}" data-id="${item.id}">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>
            `;
          }).join('') : `<div class="empty">${esc(meta.emptyText)}</div>`}
        </div>
      `;

      const toggleComposeBtn = $(`mgr-${kind}-toggle-compose`);
      if (toggleComposeBtn) {
        toggleComposeBtn.onclick = () => {
          state[meta.composeStateKey] = !Boolean(state[meta.composeStateKey]);
          if (!state[meta.composeStateKey]) state[meta.editStateKey] = null;
          managerRenderSocialPane(kind);
        };
      }

      managerSocialBindMedia(kind);
      const form = $(`mgr-${kind}-form`);
      if (form) {
        form.onsubmit = (e) => {
          e.preventDefault();
          managerSaveSocial(kind);
        };
      }
      const cancelBtn = $(`mgr-${kind}-cancel`);
      if (cancelBtn) {
        cancelBtn.onclick = () => {
          state[meta.editStateKey] = null;
          state[meta.composeStateKey] = false;
          managerRenderSocialPane(kind);
        };
      }
      pane.querySelectorAll(`[data-social-edit="${kind}"]`).forEach((btn) => {
        btn.onclick = () => {
          state[meta.editStateKey] = Number(btn.dataset.id);
          state[meta.composeStateKey] = true;
          managerRenderSocialPane(kind);
        };
      });
      pane.querySelectorAll(`[data-social-del="${kind}"]`).forEach((btn) => {
        btn.onclick = () => managerDeleteSocial(kind, Number(btn.dataset.id));
      });
    }

    async function managerLoadSocial(kind) {
      const meta = managerSocialKindMeta(kind);
      const pane = $(meta.paneId);
      if (!pane) return;
      if (!state.activeGroupId) {
        pane.innerHTML = '<div class="empty">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã.</div>';
        return;
      }
      pane.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      const data = await api(`${meta.endpoint}?group=${state.activeGroupId}`);
      state[meta.listStateKey] = Array.isArray(data) ? data : [];
      if (!state[meta.listStateKey].some((x) => Number(x.id) === Number(state[meta.editStateKey] || 0))) {
        state[meta.editStateKey] = null;
      }
      managerRenderSocialPane(kind);
    }

    function managerLoadEvents() { return managerLoadSocial('events'); }
    function managerLoadFeed() { return managerLoadSocial('feed'); }

    async function managerSaveSocial(kind) {
      const meta = managerSocialKindMeta(kind);
      if (!state.activeGroupId) return;
      const form = $(`mgr-${kind}-form`);
      if (!form || !form.reportValidity()) return;
      const editId = Number($(`mgr-${kind}-edit-id`)?.value || 0);
      managerSocialSetStatus(kind, editId ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ–∑–¥–∞–Ω–∏–µ...');
      try {
        const payload = managerSocialCollect(kind);
        if (editId) {
          await api(`${meta.endpoint}${editId}/`, 'PUT', payload);
        } else {
          await api(meta.endpoint, 'POST', payload);
        }
        state[meta.editStateKey] = null;
        state[meta.composeStateKey] = false;
        await managerLoadSocial(kind);
        managerSocialSetStatus(kind, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.');
      } catch (e) {
        managerSocialSetStatus(kind, e.message);
      }
    }

    async function managerDeleteSocial(kind, id) {
      const meta = managerSocialKindMeta(kind);
      if (!id) return;
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      try {
        await api(`${meta.endpoint}${id}/`, 'DELETE');
        if (Number(state[meta.editStateKey]) === Number(id)) state[meta.editStateKey] = null;
        await managerLoadSocial(kind);
      } catch (e) {
        const pane = $(meta.paneId);
        if (pane) {
          const msg = document.createElement('div');
          msg.className = 'manager-social-status';
          msg.textContent = e.message;
          pane.prepend(msg);
        }
      }
    }

    function cloneDevMethodDraft(methodObj) {
      return {
        id: methodObj.id,
        subject: methodObj.subject,
        method_number: Number(methodObj.method_number || 1),
        title: String(methodObj.title || ''),
        description: String(methodObj.description || ''),
        material_url: String(methodObj.material_url || ''),
        content_blocks: Array.isArray(methodObj.content_blocks)
          ? JSON.parse(JSON.stringify(methodObj.content_blocks))
          : [],
      };
    }

    function ensureDevEditorDraft(methodObj) {
      if (!methodObj) return null;
      if (Number(state.devEditorMethodId) !== Number(methodObj.id) || !state.devEditorDraft) {
        state.devEditorMethodId = methodObj.id;
        state.devEditorDraft = cloneDevMethodDraft(methodObj);
      }
      return state.devEditorDraft;
    }

    function defaultDevBlock(type) {
      return devNormalizeMethodBlock({ type });
    }

    function devNormalizeMethodBlock(block) {
      const raw = block || {};
      const type = raw.type || 'text';
      const style = raw.style || {};
      const styleBase = {
        textColor: String(style.textColor || '#1d2433'),
        fontSize: Number(style.fontSize || (type === 'heading' ? 32 : 18)),
        textAlign: String(style.textAlign || 'left'),
        maxWidth: Number(style.maxWidth || 100),
        radius: Number(style.radius || 10),
        bgColor: String(style.bgColor || (type === 'quote' ? '#eaf0ff' : 'transparent')),
        captionColor: String(style.captionColor || '#66758f'),
        captionSize: Number(style.captionSize || 12),
      };
      if (type === 'heading') return { type: 'heading', text: String(raw.text || ''), style: styleBase };
      if (type === 'quote') return { type: 'quote', text: String(raw.text || ''), style: styleBase };
      if (type === 'image') return { type: 'image', url: String(raw.url || ''), caption: String(raw.caption || ''), style: styleBase };
      if (type === 'video') return { type: 'video', url: String(raw.url || ''), caption: String(raw.caption || ''), style: styleBase };
      return { type: 'text', text: String(raw.text || ''), style: styleBase };
    }

    function devAddStyleControls(block, box, onChange) {
      const controls = document.createElement('div');
      controls.className = 'row';
      controls.style.marginTop = '8px';

      const color = document.createElement('input');
      color.type = 'color';
      color.value = block.style.textColor || '#1d2433';
      color.title = '–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞';
      color.oninput = () => { block.style.textColor = color.value; onChange(); };

      const size = document.createElement('input');
      size.type = 'number';
      size.min = '10';
      size.max = '72';
      size.value = String(block.style.fontSize || 18);
      size.placeholder = '–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞';
      size.oninput = () => { block.style.fontSize = Number(size.value || 18); onChange(); };

      const align = document.createElement('select');
      align.innerHTML = '<option value="left">–°–ª–µ–≤–∞</option><option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option><option value="right">–°–ø—Ä–∞–≤–∞</option>';
      align.value = block.style.textAlign || 'left';
      align.onchange = () => { block.style.textAlign = align.value; onChange(); };

      controls.appendChild(color);
      controls.appendChild(size);
      controls.appendChild(align);
      box.appendChild(controls);
    }

    function devAddMediaStyleControls(block, box, onChange) {
      const controls = document.createElement('div');
      controls.className = 'row';
      controls.style.marginTop = '8px';

      const width = document.createElement('input');
      width.type = 'number';
      width.min = '20';
      width.max = '100';
      width.value = String(block.style.maxWidth || 100);
      width.placeholder = '–®–∏—Ä–∏–Ω–∞ %';
      width.oninput = () => { block.style.maxWidth = Number(width.value || 100); onChange(); };

      const radius = document.createElement('input');
      radius.type = 'number';
      radius.min = '0';
      radius.max = '40';
      radius.value = String(block.style.radius || 10);
      radius.placeholder = '–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ';
      radius.oninput = () => { block.style.radius = Number(radius.value || 10); onChange(); };

      const align = document.createElement('select');
      align.innerHTML = '<option value="left">–°–ª–µ–≤–∞</option><option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option><option value="right">–°–ø—Ä–∞–≤–∞</option>';
      align.value = block.style.textAlign || 'left';
      align.onchange = () => { block.style.textAlign = align.value; onChange(); };

      controls.appendChild(width);
      controls.appendChild(radius);
      controls.appendChild(align);
      box.appendChild(controls);

      const capControls = document.createElement('div');
      capControls.className = 'row';
      capControls.style.marginTop = '8px';
      const capColor = document.createElement('input');
      capColor.type = 'color';
      capColor.value = block.style.captionColor || '#66758f';
      capColor.oninput = () => { block.style.captionColor = capColor.value; onChange(); };
      const capSize = document.createElement('input');
      capSize.type = 'number';
      capSize.min = '10';
      capSize.max = '24';
      capSize.value = String(block.style.captionSize || 12);
      capSize.oninput = () => { block.style.captionSize = Number(capSize.value || 12); onChange(); };
      capControls.appendChild(capColor);
      capControls.appendChild(capSize);
      box.appendChild(capControls);
    }

    function renderTeacherDevEditor(methodObj, assignment) {
      const mount = $('teacher-dev-editor');
      if (!mount) return;
      if (!methodObj || !assignment || !assignment.can_edit) {
        mount.innerHTML = '<div class="empty">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–≥–¥–∞ –º–µ—Ç–æ–¥ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>';
        return;
      }
      const draft = ensureDevEditorDraft(methodObj);
      mount.innerHTML = `
        <div class="dev-editor">
          <h4>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –º–µ—Ç–æ–¥–∞</h4>
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="dev-method-title" value="${esc(draft.title)}" />
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="dev-method-description">${esc(draft.description)}</textarea>
          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</label>
          <input id="dev-method-url" value="${esc(draft.material_url)}" placeholder="https://..." />
          <div class="dev-editor-toolbar">
            <button class="method-btn" type="button" id="dev-add-heading">+ –ó–∞–≥–æ–ª–æ–≤–æ–∫</button>
            <button class="method-btn" type="button" id="dev-add-text">+ –¢–µ–∫—Å—Ç</button>
            <button class="method-btn" type="button" id="dev-add-quote">+ –¶–∏—Ç–∞—Ç–∞</button>
            <button class="method-btn" type="button" id="dev-add-image">+ –ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
            <button class="method-btn" type="button" id="dev-add-video">+ –í–∏–¥–µ–æ</button>
          </div>
          <div id="dev-editor-blocks" class="dev-blocks"></div>
          <div class="dev-preview">
            <div class="teacher-item-meta" style="margin-bottom:6px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–∫–∞–∫ —É–≤–∏–¥–∏—Ç —Å—Ç—É–¥–µ–Ω—Ç)</div>
            <div id="dev-editor-preview"></div>
          </div>
          <div class="dev-save-row">
            <button class="method-btn" type="button" id="dev-method-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–æ–¥</button>
            <span id="dev-save-status" class="dev-save-status"></span>
          </div>
        </div>
      `;

      const syncTopFields = () => {
        draft.title = $('dev-method-title') ? $('dev-method-title').value : draft.title;
        draft.description = $('dev-method-description') ? $('dev-method-description').value : draft.description;
        draft.material_url = $('dev-method-url') ? $('dev-method-url').value : draft.material_url;
        renderTeacherDevEditorPreview();
      };
      $('dev-method-title').addEventListener('input', syncTopFields);
      $('dev-method-description').addEventListener('input', syncTopFields);
      $('dev-method-url').addEventListener('input', syncTopFields);

      $('dev-add-heading').onclick = () => { draft.content_blocks.push(defaultDevBlock('heading')); renderTeacherDevEditorBlocks(); };
      $('dev-add-text').onclick = () => { draft.content_blocks.push(defaultDevBlock('text')); renderTeacherDevEditorBlocks(); };
      $('dev-add-quote').onclick = () => { draft.content_blocks.push(defaultDevBlock('quote')); renderTeacherDevEditorBlocks(); };
      $('dev-add-image').onclick = () => { draft.content_blocks.push(defaultDevBlock('image')); renderTeacherDevEditorBlocks(); };
      $('dev-add-video').onclick = () => { draft.content_blocks.push(defaultDevBlock('video')); renderTeacherDevEditorBlocks(); };
      $('dev-method-save').onclick = () => saveTeacherDevMethod(methodObj, assignment);

      renderTeacherDevEditorBlocks();
      renderTeacherDevEditorPreview();
    }

    function renderTeacherDevEditorBlocks() {
      const wrap = $('dev-editor-blocks');
      if (!wrap || !state.devEditorDraft) return;
      const draft = state.devEditorDraft;
      wrap.innerHTML = '';
      draft.content_blocks = draft.content_blocks.map((b) => devNormalizeMethodBlock(b));
      const titleMap = { heading: '–ó–∞–≥–æ–ª–æ–≤–æ–∫', text: '–¢–µ–∫—Å—Ç', quote: '–¶–∏—Ç–∞—Ç–∞', image: '–ö–∞—Ä—Ç–∏–Ω–∫–∞', video: '–í–∏–¥–µ–æ' };
      draft.content_blocks.forEach((raw, idx) => {
        const b = raw || {};
        const type = b.type || 'text';
        const box = document.createElement('div');
        box.className = 'block-item';
        box.innerHTML = `
          <div class="block-head">
            <div class="block-kind">–ë–ª–æ–∫ ${idx + 1}: ${titleMap[type] || type}</div>
            <div class="block-actions">
              <button type="button" data-act="up" data-i="${idx}">–í–≤–µ—Ä—Ö</button>
              <button type="button" data-act="down" data-i="${idx}">–í–Ω–∏–∑</button>
              <button type="button" data-act="del" data-i="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
        if (type === 'heading' || type === 'text' || type === 'quote') {
          const ta = document.createElement('textarea');
          ta.rows = type === 'heading' ? 2 : 4;
          ta.value = String(b.text || '');
          ta.placeholder = type === 'heading' ? '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞' : (type === 'quote' ? '–¶–∏—Ç–∞—Ç–∞/–≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫' : '–¢–µ–∫—Å—Ç –±–ª–æ–∫–∞');
          ta.oninput = () => { draft.content_blocks[idx].text = ta.value; renderTeacherDevEditorPreview(); };
          box.appendChild(ta);
          devAddStyleControls(draft.content_blocks[idx], box, renderTeacherDevEditorPreview);
          if (type === 'quote') {
            const quoteBg = document.createElement('input');
            quoteBg.type = 'color';
            quoteBg.value = draft.content_blocks[idx].style.bgColor || '#eaf0ff';
            quoteBg.oninput = () => { draft.content_blocks[idx].style.bgColor = quoteBg.value; renderTeacherDevEditorPreview(); };
            box.appendChild(quoteBg);
          }
        } else {
          const url = document.createElement('input');
          url.readOnly = true;
          url.value = String(b.url || '');
          url.placeholder = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
          box.appendChild(url);
          const uploadRow = document.createElement('div');
          uploadRow.className = 'block-actions';
          uploadRow.style.marginTop = '6px';
          const pickBtn = document.createElement('button');
          pickBtn.type = 'button';
          pickBtn.textContent = type === 'image' ? '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ';
          const uploadStatus = document.createElement('span');
          uploadStatus.className = 'teacher-item-meta';
          uploadStatus.style.alignSelf = 'center';
          uploadStatus.textContent = '';
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = type === 'image' ? 'image/*' : 'video/*';
          fileInput.style.display = 'none';
          pickBtn.onclick = () => fileInput.click();
          fileInput.onchange = async () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            try {
              uploadStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
              const uploadedUrl = await uploadMedia(file);
              draft.content_blocks[idx].url = uploadedUrl;
              url.value = uploadedUrl;
              renderTeacherDevEditorBlocks();
              renderTeacherDevEditorPreview();
            } catch (e) {
              uploadStatus.textContent = e.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
              return;
            }
            uploadStatus.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
          };
          uploadRow.appendChild(pickBtn);
          uploadRow.appendChild(uploadStatus);
          uploadRow.appendChild(fileInput);
          box.appendChild(uploadRow);
          const cap = document.createElement('input');
          cap.style.marginTop = '6px';
          cap.value = String(b.caption || '');
          cap.placeholder = '–ü–æ–¥–ø–∏—Å—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)';
          cap.oninput = () => { draft.content_blocks[idx].caption = cap.value; renderTeacherDevEditorPreview(); };
          box.appendChild(cap);
          devAddMediaStyleControls(draft.content_blocks[idx], box, renderTeacherDevEditorPreview);
        }
        box.querySelectorAll('button[data-act]').forEach((btn) => {
          btn.onclick = () => {
            const i = Number(btn.dataset.i);
            const act = btn.dataset.act;
            if (act === 'del') draft.content_blocks.splice(i, 1);
            if (act === 'up' && i > 0) [draft.content_blocks[i - 1], draft.content_blocks[i]] = [draft.content_blocks[i], draft.content_blocks[i - 1]];
            if (act === 'down' && i < draft.content_blocks.length - 1) [draft.content_blocks[i + 1], draft.content_blocks[i]] = [draft.content_blocks[i], draft.content_blocks[i + 1]];
            renderTeacherDevEditorBlocks();
            renderTeacherDevEditorPreview();
          };
        });
        wrap.appendChild(box);
      });
      if (!draft.content_blocks.length) {
        wrap.innerHTML = '<div class="empty">–ë–ª–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å —Å–≤–µ—Ä—Ö—É –ø–µ—Ä–≤—ã–π –±–ª–æ–∫.</div>';
      }
    }

    function renderTeacherDevEditorPreview() {
      const preview = $('dev-editor-preview');
      if (!preview || !state.devEditorDraft) return;
      const draft = state.devEditorDraft;
      const normalizedBlocks = (draft.content_blocks || []).map((b) => devNormalizeMethodBlock(b));
      preview.innerHTML = '';
      preview.className = 'live-page';

      const header = document.createElement('div');
      header.className = 'live-header';
      header.innerHTML = `<div class="live-badge">–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç</div><h2 class="live-title">${draft.title ? esc(draft.title) : '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞'}</h2>`;
      if (draft.description) {
        const d = document.createElement('p');
        d.className = 'live-desc';
        d.textContent = draft.description;
        header.appendChild(d);
      }
      if (draft.material_url) {
        const a = document.createElement('a');
        a.className = 'live-material-link';
        a.href = draft.material_url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = '–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã';
        header.appendChild(a);
      }
      preview.appendChild(header);
      if (!normalizedBlocks.length) {
        const empty = document.createElement('div');
        empty.className = 'live-desc';
        empty.textContent = '–î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫–∏ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Ä–æ–∫–∞.';
        preview.appendChild(empty);
        return;
      }

      normalizedBlocks.forEach((block) => {
        const section = document.createElement('section');
        section.className = 'live-block';
        section.style.textAlign = block.style.textAlign || 'left';
        if (block.type === 'heading') {
          const h = document.createElement('h3');
          h.textContent = block.text || '';
          h.style.color = block.style.textColor;
          h.style.fontSize = `${block.style.fontSize}px`;
          section.appendChild(h);
        }
        if (block.type === 'text') {
          const p = document.createElement('p');
          p.textContent = block.text || '';
          p.style.color = block.style.textColor;
          p.style.fontSize = `${block.style.fontSize}px`;
          section.appendChild(p);
        }
        if (block.type === 'quote') {
          const q = document.createElement('div');
          q.className = 'live-quote';
          q.textContent = block.text || '';
          q.style.color = block.style.textColor;
          q.style.fontSize = `${block.style.fontSize}px`;
          q.style.background = block.style.bgColor || '#eaf0ff';
          section.appendChild(q);
        }
        if (block.type === 'image' && block.url) {
          const img = document.createElement('img');
          img.src = block.url;
          img.alt = block.caption || 'image';
          img.style.maxWidth = `${block.style.maxWidth}%`;
          img.style.borderRadius = `${block.style.radius}px`;
          if (block.style.textAlign === 'center') img.style.margin = '0 auto';
          if (block.style.textAlign === 'right') img.style.margin = '0 0 0 auto';
          section.appendChild(img);
          if (block.caption) {
            const cap = document.createElement('div');
            cap.className = 'live-caption';
            cap.textContent = block.caption;
            cap.style.color = block.style.captionColor;
            cap.style.fontSize = `${block.style.captionSize}px`;
            section.appendChild(cap);
          }
        }
        if (block.type === 'video' && block.url) {
          const embed = toEmbedUrl(block.url);
          if (embed) {
            const iframe = document.createElement('iframe');
            iframe.src = embed;
            iframe.allowFullscreen = true;
            iframe.style.maxWidth = `${block.style.maxWidth}%`;
            iframe.style.borderRadius = `${block.style.radius}px`;
            if (block.style.textAlign === 'center') iframe.style.margin = '0 auto';
            if (block.style.textAlign === 'right') iframe.style.margin = '0 0 0 auto';
            section.appendChild(iframe);
          } else {
            const video = document.createElement('video');
            video.src = block.url;
            video.controls = true;
            video.style.width = `${block.style.maxWidth}%`;
            video.style.borderRadius = `${block.style.radius}px`;
            if (block.style.textAlign === 'center') video.style.margin = '0 auto';
            if (block.style.textAlign === 'right') video.style.margin = '0 0 0 auto';
            section.appendChild(video);
          }
          if (block.caption) {
            const cap = document.createElement('div');
            cap.className = 'live-caption';
            cap.textContent = block.caption;
            cap.style.color = block.style.captionColor;
            cap.style.fontSize = `${block.style.captionSize}px`;
            section.appendChild(cap);
          }
        }
        preview.appendChild(section);
      });
    }

    async function saveTeacherDevMethod(methodObj, assignment) {
      if (!assignment || !assignment.can_edit || !methodObj || !state.devEditorDraft) return;
      const statusEl = $('dev-save-status');
      if (statusEl) statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      try {
        const d = state.devEditorDraft;
        const payload = {
          subject: methodObj.subject,
          method_number: Number(methodObj.method_number || 1),
          title: String(d.title || '').trim() || `–£—Ä–æ–∫ ${methodObj.method_number || ''}`,
          description: String(d.description || ''),
          material_url: String(d.material_url || ''),
          content_blocks: (Array.isArray(d.content_blocks) ? d.content_blocks : []).map((b) => {
            const type = b.type || 'text';
            if (type === 'image' || type === 'video') {
              return { type, url: String(b.url || '').trim(), caption: String(b.caption || '').trim(), style: b.style || {} };
            }
            return { type, text: String(b.text || '').trim(), style: b.style || {} };
          }).filter((b) => (['image', 'video'].includes(b.type) ? b.url : b.text)),
        };
        const updated = await api(`/api/method-packages/${methodObj.id}/`, 'PUT', payload);
        state.methods = state.methods.map((m) => (Number(m.id) === Number(updated.id) ? updated : m));
        state.devEditorMethodId = updated.id;
        state.devEditorDraft = cloneDevMethodDraft(updated);
        if (statusEl) statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
        renderTeacherDevelopmentList();
        renderTeacherDevelopmentDetail();
        if (state.activeView === 'methods') renderTeacherMethodsList();
      } catch (e) {
        if (statusEl) statusEl.textContent = e.message;
      }
    }

    function openMethodInNewTab(methodObj) {
      const win = window.open('', '_blank');
      if (!win) return;
      const title = esc(methodObj.title || '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç');
      win.document.open();
      win.document.write(`<!doctype html><html lang="ru"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><title>${title}</title><style>
        body{margin:0;background:#0b1021;color:#f0f5ff;font-family:Trebuchet MS,Segoe UI,system-ui,sans-serif;padding:18px;}
        .wrap{max-width:1080px;margin:0 auto;}
        .live-page{background:#f5f7fb;color:#1d2433;border-radius:12px;border:1px solid #dfe5f1;padding:20px;min-height:240px;}
        .live-header{text-align:center;margin-bottom:18px;}
        .live-badge{display:inline-block;padding:8px 14px;border-radius:999px;background:#eaf2ff;color:#2f5cab;font-size:12px;font-weight:700;margin-bottom:8px;}
        .live-title{margin:0;font-size:30px;line-height:1.2;font-weight:800;color:#17203a;}
        .live-desc{margin:10px auto 0;max-width:820px;color:#52607a;text-align:center;}
        .live-material-link{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;background:#1f6feb;color:#fff;font-weight:700;text-decoration:none;}
        .live-block{margin:16px 0;}
        .live-block h3{margin:0 0 8px;font-size:25px;line-height:1.25;}
        .live-block p{margin:0;line-height:1.65;}
        .live-quote{border-left:4px solid #6d8ed6;background:#eaf0ff;color:#27334d;padding:12px 14px;border-radius:8px;}
        .live-block img{max-width:100%;border-radius:10px;border:1px solid #d8dfef;display:block;}
        .live-block iframe{width:100%;min-height:360px;border:none;border-radius:10px;background:#0f172a;display:block;}
        .live-caption{margin-top:6px;font-size:12px;color:#66758f;}
        .method-btn{display:inline-block;border:1px solid #d8dfef;background:#fff;color:#334155;border-radius:8px;padding:6px 10px;text-decoration:none;font-size:13px;}
      </style></head><body><div class="wrap"><div id="mp-root"></div></div></body></html>`);
      win.document.close();
      const root = win.document.getElementById('mp-root');
      if (root) renderMethodLivePage(root, methodObj, win.document);
    }

    function renderTeacherMethodViewer(methodObj) {
      const viewer = $('teacher-method-viewer');
      if (!methodObj) {
        viewer.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥–ø–∞–∫–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å"';
        return;
      }
      viewer.innerHTML = '';
      const head = document.createElement('div');
      head.className = 'method-viewer-head';
      const h = document.createElement('h3');
      h.textContent = methodObj.title || '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç';
      const collapseBtn = document.createElement('button');
      collapseBtn.type = 'button';
      collapseBtn.className = 'method-collapse-btn';
      collapseBtn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
      collapseBtn.onclick = () => {
        state.openMethodId = null;
        renderTeacherMethodsList();
        renderTeacherMethodViewer(null);
      };
      head.appendChild(h);
      head.appendChild(collapseBtn);
      viewer.appendChild(head);
      const actions = document.createElement('div');
      actions.className = 'method-actions';
      const openTabBtn = document.createElement('button');
      openTabBtn.type = 'button';
      openTabBtn.className = 'method-btn';
      openTabBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ';
      openTabBtn.onclick = () => openMethodInNewTab(methodObj);
      actions.appendChild(openTabBtn);
      if (methodObj.material_url) {
        const a = document.createElement('a');
        a.className = 'method-btn';
        a.href = methodObj.material_url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = '–ò—Å—Ç–æ—á–Ω–∏–∫';
        actions.appendChild(a);
      }
      viewer.appendChild(actions);
      renderMethodLivePage(viewer, methodObj);
    }

    function statusLabel(code) {
      const map = {
        todo: '–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é',
        in_progress: '–í —Ä–∞–±–æ—Ç–µ',
        review: '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
        done: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
      };
      return map[String(code || '')] || (code || '‚Äî');
    }

    function fmtDateTime(v) {
      if (!v) return '';
      const d = new Date(v);
      if (Number.isNaN(d.getTime())) return '';
      return d.toLocaleString([], { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function assignmentForMethod(methodId) {
      return state.assignments.find((a) => Number(a.method_package) === Number(methodId)) || null;
    }

    function isOwnAssignmentComment(c) {
      const role = String((state.me && state.me.role) || ROLE || '').toLowerCase();
      const senderRole = String(c.sender_role || '').toLowerCase();
      return senderRole === role || (state.me && c.sender_username && c.sender_username === state.me.username);
    }

    async function loadAssignmentComments(assignmentId, rerender = false) {
      try {
        const comments = await api(`/api/method-assignments/${assignmentId}/comments/`);
        state.assignmentCommentsCache[assignmentId] = comments;
        if (rerender) {
          if (state.activeView === 'development') renderTeacherDevelopmentDetail();
        }
      } catch (_) {}
    }

    async function sendAssignmentComment(assignmentId, inputId) {
      const input = $(inputId);
      const text = String(input && input.value || '').trim();
      if (!text) return;
      $('status').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è...';
      try {
        await api(`/api/method-assignments/${assignmentId}/comments/`, 'POST', { text });
        if (input) input.value = '';
        await loadAssignmentComments(assignmentId, true);
        $('status').textContent = '';
      } catch (e) {
        $('status').textContent = e.message;
      }
    }

    async function submitAssignmentForReview(assignmentId) {
      $('status').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É...';
      try {
        const updated = await api(`/api/method-assignments/${assignmentId}/submit/`, 'POST', {});
        state.assignments = state.assignments.map((a) => a.id === updated.id ? updated : a);
        await loadAssignmentComments(assignmentId);
        if (state.activeView === 'development') {
          renderTeacherDevelopmentList();
          renderTeacherDevelopmentDetail();
        }
        if (state.activeView === 'methods') {
          renderTeacherMethodsList();
        }
        $('status').textContent = '';
      } catch (e) {
        $('status').textContent = e.message;
      }
    }

    function renderTeacherMethodsList() {
      const box = $('teacher-methods-list');
      const filter = $('teacher-methods-subject-filter');
      const count = $('teacher-methods-count');
      const selectedSubject = String(filter ? filter.value : '');
      const subjectMethods = state.methods.filter((m) => String(m.subject_name || '') === selectedSubject);
      const publishedMethods = subjectMethods.filter((m) => {
        const a = assignmentForMethod(m.id);
        return !a || a.status === 'done';
      });
      const hiddenDevNumbers = new Set(
        subjectMethods
          .filter((m) => {
            const a = assignmentForMethod(m.id);
            return a && a.status !== 'done';
          })
          .map((m) => Number(m.method_number || 0))
      );
      const filtered = publishedMethods;
      const byNumber = new Map(publishedMethods.map((m) => [Number(m.method_number || 0), m]));

      const rows = [];
      for (let num = 1; num <= 12; num += 1) {
        const method = byNumber.get(num) || null;
        rows.push(`
          <tr>
            <td class="methods-template-number">${num}</td>
            <td class="methods-template-title${method ? '' : ' placeholder'}">${method ? esc(method.title || '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç') : (hiddenDevNumbers.has(num) ? '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è' : '–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')}</td>
            <td class="methods-template-open">
              ${method
                ? `<button class="method-btn" type="button" data-method-open="${method.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
                   <button class="method-btn" type="button" data-method-open-tab="${method.id}">–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞</button>`
                : '<span class="teacher-item-meta">‚Äî</span>'}
            </td>
          </tr>
        `);
      }

      box.innerHTML = `
        <div class="methods-template-wrap">
          <table class="methods-template">
            <thead>
              <tr>
                <th>‚Ññ</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</th>
                <th>–û—Ç–∫—Ä—ã—Ç–∏–µ</th>
              </tr>
            </thead>
            <tbody>${rows.join('')}</tbody>
          </table>
        </div>
      `;

      if (count) {
        count.textContent = selectedSubject
          ? `–ü—Ä–µ–¥–º–µ—Ç: ${selectedSubject} ¬∑ –¥–æ—Å—Ç—É–ø–Ω–æ ${publishedMethods.length}/12`
          : '–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ¬∑ —à–∞–±–ª–æ–Ω 1-12';
      }

      if (!selectedSubject) {
        state.openMethodId = null;
        renderTeacherMethodViewer(null);
      } else {
        const selected = filtered.find((x) => x.id === state.openMethodId) || null;
        renderTeacherMethodViewer(selected);
      }

      box.querySelectorAll('[data-method-open]').forEach((btn) => {
        btn.onclick = () => {
          const id = Number(btn.dataset.methodOpen);
          const target = filtered.find((x) => x.id === id);
          state.openMethodId = target ? target.id : null;
          renderTeacherMethodsList();
          renderTeacherMethodViewer(target || null);
        };
      });
      box.querySelectorAll('[data-method-open-tab]').forEach((btn) => {
        btn.onclick = () => {
          const id = Number(btn.dataset.methodOpenTab);
          const target = filtered.find((x) => x.id === id);
          if (target) openMethodInNewTab(target);
        };
      });
    }

    function teacherDevelopmentAssignments() {
      return state.assignments
        .filter((a) => a && a.status !== 'done')
        .slice()
        .sort((a, b) => {
          const s = String(a.method_subject_name || '').localeCompare(String(b.method_subject_name || ''));
          if (s) return s;
          const n = Number(a.method_number || 0) - Number(b.method_number || 0);
          if (n) return n;
          return Number(a.id || 0) - Number(b.id || 0);
        });
    }

    function renderTeacherDevelopmentList() {
      const box = $('teacher-dev-list');
      const summary = $('teacher-dev-summary');
      if (!box || !summary) return;
      const items = teacherDevelopmentAssignments();
      summary.textContent = items.length
        ? `–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ/–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ: ${items.length}. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Ö–æ–¥—è—Ç –∏–∑ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏.`
        : '–ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ—Ç';
      if (!items.length) {
        box.innerHTML = '<div class="empty">–ù–µ—Ç –º–µ—Ç–æ–¥–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>';
        $('teacher-dev-detail').innerHTML = '–ú–µ—Ç–æ–¥–∏—Å—Ç –ø–æ–∫–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–∏–ª –≤–∞–º –º–µ—Ç–æ–¥—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É.';
        state.devAssignmentId = null;
        return;
      }
      if (!items.some((a) => Number(a.id) === Number(state.devAssignmentId))) {
        state.devAssignmentId = items[0].id;
      }
      box.innerHTML = items.map((a) => `
        <div class="dev-card${Number(a.id) === Number(state.devAssignmentId) ? ' active' : ''}" data-dev-assignment="${a.id}">
          <div class="dev-card-title">${esc(a.method_title || '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç')}</div>
          <div class="dev-card-meta">
            ${esc(a.method_subject_name || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞')} ¬∑ –ú–µ—Ç–æ–¥ ${Number(a.method_number || 0) || '‚Äî'}<br>
            ${a.can_edit ? '–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç' : '–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ'}
          </div>
          <div class="status-badge ${esc(a.status)}">${esc(statusLabel(a.status))}</div>
        </div>
      `).join('');
      box.querySelectorAll('[data-dev-assignment]').forEach((el) => {
        el.onclick = async () => {
          state.devAssignmentId = Number(el.dataset.devAssignment);
          renderTeacherDevelopmentList();
          await loadAssignmentComments(state.devAssignmentId, true);
          renderTeacherDevelopmentDetail();
        };
      });
      renderTeacherDevelopmentDetail();
    }

    function renderTeacherDevelopmentDetail() {
      const box = $('teacher-dev-detail');
      if (!box) return;
      const assignment = state.assignments.find((a) => Number(a.id) === Number(state.devAssignmentId)) || null;
      if (!assignment) {
        box.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–µ–≤–∞';
        return;
      }
      const methodObj = state.methods.find((m) => Number(m.id) === Number(assignment.method_package)) || null;
      const comments = state.assignmentCommentsCache[assignment.id] || [];
      box.innerHTML = `
        <div class="dev-detail-head">
          <div class="dev-detail-title">${esc(assignment.method_title || '–ú–µ—Ç–æ–¥–ø–∞–∫–µ—Ç')}</div>
          <span class="status-badge ${esc(assignment.status)}">${esc(statusLabel(assignment.status))}</span>
        </div>
        <div class="dev-detail-meta">
          ${esc(assignment.method_subject_name || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞')} ¬∑ –ú–µ—Ç–æ–¥ ${Number(assignment.method_number || 0) || '‚Äî'}<br>
          ${assignment.can_edit ? '–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ'}
          ${assignment.notes ? `<br>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥–∏—Å—Ç–∞: ${esc(assignment.notes)}` : ''}
        </div>
        <div class="method-actions">
          ${methodObj && assignment.can_edit ? '<button id="teacher-dev-open-constructor" class="method-btn" type="button">–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å</button>' : ''}
          ${methodObj ? '<button id="teacher-dev-open-method" class="method-btn" type="button">–û—Ç–∫—Ä—ã—Ç—å –º–µ—Ç–æ–¥</button>' : ''}
          ${methodObj ? '<button id="teacher-dev-open-tab" class="method-btn" type="button">–ù–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞</button>' : ''}
          <button id="teacher-dev-refresh-comments" class="method-btn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
          ${assignment.can_edit && (assignment.status === 'todo' || assignment.status === 'in_progress') ? '<button id="teacher-dev-submit" class="method-btn" type="button">–°–¥–∞—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>' : ''}
        </div>
        <div class="dev-comments">
          ${comments.length ? comments.slice().reverse().map((c) => `
            <div class="dev-comment${isOwnAssignmentComment(c) ? ' self' : ''}">
              <div class="dev-comment-meta"><span>${esc(c.sender_name || c.sender_username || c.sender_role || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</span><span>${esc(fmtDateTime(c.created_at))}</span></div>
              <div class="dev-comment-text">${esc(c.text || '')}</div>
            </div>
          `).join('') : '<div class="empty">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'}
        </div>
        <div class="dev-comment-form">
          <input id="teacher-dev-comment-input" placeholder="–í–æ–ø—Ä–æ—Å –º–µ—Ç–æ–¥–∏—Å—Ç—É / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." />
          <button id="teacher-dev-comment-send" class="method-btn" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      `;
      if (methodObj) {
        const ctorBtn = $('teacher-dev-open-constructor');
        if (ctorBtn) ctorBtn.onclick = () => openTeacherMethodConstructor(methodObj);
        const openBtn = $('teacher-dev-open-method');
        if (openBtn) openBtn.onclick = () => {
          state.openMethodId = methodObj.id;
          switchView('methods');
          renderTeacherMethodsList();
          renderTeacherMethodViewer(methodObj);
        };
        const openTabBtn = $('teacher-dev-open-tab');
        if (openTabBtn) openTabBtn.onclick = () => openMethodInNewTab(methodObj);
      }
      const refreshBtn = $('teacher-dev-refresh-comments');
      if (refreshBtn) refreshBtn.onclick = () => loadAssignmentComments(assignment.id, true);
      const sendBtn = $('teacher-dev-comment-send');
      if (sendBtn) sendBtn.onclick = () => sendAssignmentComment(assignment.id, 'teacher-dev-comment-input');
      const submitBtn = $('teacher-dev-submit');
      if (submitBtn) submitBtn.onclick = () => submitAssignmentForReview(assignment.id);
    }

    async function refreshUnreadRooms() {
      if (!state.rooms.length) return;
      const checks = await Promise.all(state.rooms.map(async (room) => {
        try {
          const messages = await api(`/api/chats/${room.id}/messages/`);
          const latest = messages[0];
          if (!latest || !latest.id) return { roomId: room.id, unread: false };
          const unread = latest.id > getSeenId(room.id) && !isSelfMessage(latest);
          return { roomId: room.id, unread };
        } catch (_) {
          return { roomId: room.id, unread: false };
        }
      }));
      checks.forEach((item) => {
        if (item.unread) state.unreadRoomIds.add(item.roomId);
        else state.unreadRoomIds.delete(item.roomId);
      });
      updateBellUI();
      renderRooms();
    }

    function startUnreadPolling() {
      if (state.pollTimer) return;
      state.pollTimer = setInterval(() => {
        refreshUnreadRooms().catch(() => {});
      }, 12000);
    }

    function renderClasses() {
      const wrap = $('classes');
      wrap.innerHTML = '';

      if (!state.groups.length) {
        wrap.innerHTML = '<div class="empty">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø</div>';
        return;
      }

      state.groups.forEach((group, idx) => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = `class-card${state.activeGroupId === group.id ? ' active' : ''}`;
        card.innerHTML = `
          <div class="class-gear">‚öô</div>
          <div class="class-dot" style="background:${CLASS_COLORS[idx % CLASS_COLORS.length]};"></div>
          <div class="class-name">${esc(group.name)}</div>
          <div class="class-meta">${group.students_count} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ¬∑ ${group.parents_count} —Ä–æ–¥–∏—Ç–µ–ª–µ–π</div>
        `;
        card.onclick = () => {
          state.activeGroupId = group.id;
          portalSafeSet(portalKey('active_group_id'), group.id);
          state.scheduleWeekOffset = 0;
          const list = state.rooms.filter((room) => Number(room.group) === Number(group.id));
          state.activeRoomId = list[0] ? list[0].id : null;
          if (state.activeRoomId) portalSafeSet(portalKey('active_room_id'), state.activeRoomId);
          renderClasses();
          renderRooms();
          if (state.activeView === 'chat') loadMessages();
          if (state.activeView === 'schedule') loadTeacherSchedule();
          if (state.activeView === 'methods') loadTeacherMethods();
          if (ROLE === 'manager' && state.activeView === 'events') managerLoadEvents().catch(() => {});
          if (ROLE === 'manager' && state.activeView === 'feed') managerLoadFeed().catch(() => {});
        };
        wrap.appendChild(card);
      });
    }

    function renderTeacherScheduleWeek() {
      const tbody = $('teacher-schedule-body-grid');
      const headRow = $('teacher-schedule-head-row');
      const weekTitle = $('teacher-week-title');
      const weekRange = $('teacher-week-range');
      const status = $('teacher-schedule-status');
      tbody.innerHTML = '';
      headRow.innerHTML = '';

      const dayNamesFull = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
      const monday = getMonday(new Date(), state.scheduleWeekOffset);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      weekRange.textContent = formatDateRange(monday, sunday);
      weekTitle.textContent = `${dayNamesFull[(new Date().getDay() + 6) % 7]}, ${formatDate(new Date())}`;

      const dayDates = [];
      for (let i = 0; i < 7; i += 1) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        dayDates.push(d);
      }

      const first = document.createElement('th');
      first.textContent = '–ü–∞—Ä–∞';
      headRow.appendChild(first);
      dayDates.forEach((d, idx) => {
        const th = document.createElement('th');
        th.textContent = `${dayNamesFull[idx]} ${formatDate(d)}`;
        headRow.appendChild(th);
      });

      const cellMap = {};
      state.scheduleSlots.forEach((slot) => {
        const lessonNumber = Number(slot.lesson_number || 0);
        if (!lessonNumber) return;
        let dayIndex = Number(slot.weekday);
        if (slot.lesson_date) {
          const sd = parseDate(slot.lesson_date);
          if (!sd) return;
          const keyDate = sd.toDateString();
          const idx = dayDates.findIndex((d) => d.toDateString() === keyDate);
          if (idx === -1) return;
          dayIndex = idx;
        } else if (!(dayIndex >= 0 && dayIndex <= 6)) {
          return;
        }
        const key = `${dayIndex}-${lessonNumber}`;
        if (!cellMap[key]) cellMap[key] = [];
        cellMap[key].push(slot);
      });
      Object.keys(cellMap).forEach((k) => {
        cellMap[k].sort((a, b) => (hhmm(a.start_time) || '').localeCompare(hhmm(b.start_time) || ''));
      });

      const activeGroup = state.groups.find((g) => Number(g.id) === Number(state.activeGroupId));
      const activeGroupName = activeGroup && activeGroup.name ? activeGroup.name : '–ì—Ä—É–ø–ø–∞';

      const maxLesson = 12;
      for (let lesson = 1; lesson <= maxLesson; lesson += 1) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="width:60px;text-align:center;font-weight:700;">${lesson}</td>`;
        for (let day = 0; day < 7; day += 1) {
          const td = document.createElement('td');
          const list = cellMap[`${day}-${lesson}`] || [];
          if (list.length) {
            list.forEach((slot) => {
              const card = document.createElement('div');
              card.className = 'slot-card';
              const start = hhmm(slot.start_time);
              const duration = Number(slot.duration_minutes || 80);
              const end = addMinutesToTime(start, duration);
              const subjectName = (slot.lesson_topic && slot.lesson_topic.subject_name)
                ? slot.lesson_topic.subject_name
                : ((slot.method_package && slot.method_package.subject_name) ? slot.method_package.subject_name : '–ü—Ä–µ–¥–º–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω');
              card.innerHTML = `
                <div class="slot-title">${esc(activeGroupName)}</div>
                <div class="slot-subject">${esc(subjectName)}</div>
                <div class="slot-time">${esc(start)}-${esc(end)}</div>
              `;
              td.appendChild(card);
            });
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      status.textContent = state.scheduleSlots.length ? '' : '–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã';
    }

    async function loadTeacherSchedule() {
      if (ROLE !== 'teacher') return;
      const groupId = state.activeGroupId;
      state.scheduleSlots = [];
      if (!groupId) {
        $('teacher-schedule-status').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ß–∞—Ç"';
        renderTeacherScheduleWeek();
        return;
      }
      $('teacher-schedule-status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      try {
        state.scheduleSlots = await api(`/api/groups/${groupId}/schedule/`);
        renderTeacherScheduleWeek();
      } catch (e) {
        $('teacher-schedule-status').textContent = esc(e.message);
      }
    }

    async function loadTeacherMethods() {
      if (ROLE !== 'teacher') return;
      const box = $('teacher-methods-list');
      const subjectFilter = $('teacher-methods-subject-filter');
      box.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      renderTeacherMethodViewer(null);
      try {
        const [methods, assignments] = await Promise.all([
          api('/api/method-packages/'),
          api('/api/method-assignments/'),
        ]);
        state.methods = methods;
        state.assignments = assignments;
        state.methods.sort((a, b) => {
          const sa = String(a.subject_name || '');
          const sb = String(b.subject_name || '');
          const bySubject = sa.localeCompare(sb);
          if (bySubject) return bySubject;
          const byNumber = Number(a.method_number || 0) - Number(b.method_number || 0);
          if (byNumber) return byNumber;
          return String(a.title || '').localeCompare(String(b.title || ''));
        });
        const subjects = Array.from(new Set(state.methods.map((m) => String(m.subject_name || '').trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));
        subjectFilter.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>' + subjects.map((s) => `<option value="${esc(s)}">${esc(s)}</option>`).join('');
        if (!subjectFilter.value) subjectFilter.value = '';
        subjectFilter.onchange = () => renderTeacherMethodsList();
        renderTeacherMethodsList();
      } catch (e) {
        state.methods = [];
        state.openMethodId = null;
        state.assignments = [];
        box.innerHTML = `<div class="empty">${esc(e.message)}</div>`;
      }
    }

    async function loadTeacherDevelopment() {
      if (ROLE !== 'teacher') return;
      try {
        const [methods, assignments] = await Promise.all([
          api('/api/method-packages/'),
          api('/api/method-assignments/'),
        ]);
        state.methods = methods || [];
        state.assignments = assignments || [];
        renderTeacherDevelopmentList();
        const selected = state.assignments.find((a) => Number(a.id) === Number(state.devAssignmentId));
        if (selected) await loadAssignmentComments(selected.id, true);
      } catch (e) {
        $('teacher-dev-summary').textContent = e.message;
        $('teacher-dev-list').innerHTML = `<div class="empty">${esc(e.message)}</div>`;
      }
    }

    function renderRooms() {
      const wrap = $('rooms');
      wrap.innerHTML = '';

      const list = state.rooms.filter((room) => Number(room.group) === Number(state.activeGroupId));
      if (!list.length) {
        wrap.innerHTML = '<div class="empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ</div>';
        return;
      }

      list.forEach((room) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `room-btn${state.activeRoomId === room.id ? ' active' : ''}`;
        btn.innerHTML = `
          <span class="room-main">
            <span class="room-dot"></span>
            <span class="room-title">${esc(roomLabel(room))}</span>
          </span>
        `;
        const unreadDot = document.createElement('span');
        unreadDot.className = 'room-unread';
        unreadDot.style.display = state.unreadRoomIds.has(room.id) ? 'inline-block' : 'none';
        btn.appendChild(unreadDot);
        btn.onclick = () => {
          state.activeRoomId = room.id;
          portalSafeSet(portalKey('active_room_id'), room.id);
          state.unreadRoomIds.delete(room.id);
          updateBellUI();
          renderRooms();
          loadMessages();
        };
        wrap.appendChild(btn);
      });
    }

    async function loadMessages() {
      const box = $('messages');
      const room = state.rooms.find((x) => x.id === state.activeRoomId);
      if (!room) {
        $('chat-title-text').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
        box.innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>';
        return;
      }

      $('chat-title-text').textContent = roomLabel(room);
      $('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      try {
        const data = await api(`/api/chats/${room.id}/messages/`);
        box.innerHTML = '';

        if (!data.length) {
          box.innerHTML = '<div class="empty">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        } else {
          const newest = data[0];
          if (newest && newest.id) {
            setSeenId(room.id, newest.id);
            state.unreadRoomIds.delete(room.id);
            updateBellUI();
          }
          data.slice().reverse().forEach((msg) => {
            const self = isSelfMessage(msg);
            const row = document.createElement('div');
            row.className = `msg-row${self ? ' self' : ''}`;
            const dt = msg.created_at ? new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            row.innerHTML = `
              <div class="avatar">${esc(shortName(msg.sender_name))}</div>
              <div class="bubble-wrap">
                <div class="bubble">
                  ${msg.text ? esc(msg.text) : ''}
                  ${msg.attachment_url ? `
                    <div class="bubble-attachment">
                      ${isImageAttachment(msg.attachment_url, msg.attachment_name) ? `<img src="${esc(msg.attachment_url)}" alt="attachment" />` : ''}
                      <a href="${esc(msg.attachment_url)}" target="_blank" rel="noopener noreferrer">üìé ${esc(msg.attachment_name || '–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª')}</a>
                    </div>
                  ` : ''}
                </div>
                <div class="meta"><span>${esc(msg.sender_name || '')}</span><span>${esc(dt)}</span></div>
              </div>
            `;
            box.appendChild(row);
          });
        }

        box.scrollTop = box.scrollHeight;
        $('status').textContent = '';
        renderRooms();
      } catch (e) {
        $('status').textContent = e.message;
      }
    }

    async function sendMessage() {
      const room = state.rooms.find((x) => x.id === state.activeRoomId);
      const input = $('message-input');
      const text = String(input.value || '').trim();
      if (!room || (!text && !state.selectedFile)) return;

      $('status').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      try {
        const payload = new FormData();
        if (text) payload.append('text', text);
        if (state.selectedFile) payload.append('attachment', state.selectedFile);
        await api(`/api/chats/${room.id}/messages/`, 'POST', payload);
        input.value = '';
        state.selectedFile = null;
        $('attachment-input').value = '';
        updateAttachmentPill();
        await loadMessages();
      } catch (e) {
        $('status').textContent = e.message;
      }
    }

    async function loadPortal() {
      try {
        const params = new URLSearchParams(window.location.search);
        const tokenFromQuery = params.get('token') || '';
        const tokenFromStorage = sessionStorage.getItem('portal_token') || '';
        state.token = tokenFromQuery || tokenFromStorage;

        if (!state.token) {
          window.location.href = '/login/';
          return;
        }

        sessionStorage.setItem('portal_token', state.token);

        state.me = await api('/api/me/');
        $('who').textContent = `${state.me.username || ''} (${state.me.role || ROLE})`;

        await resolveMyDisplayName();

        state.rooms = await api('/api/chats/');

        const groupIds = [...new Set(state.rooms.map((room) => Number(room.group)))];
        const groupDetails = await Promise.all(groupIds.map((id) => api(`/api/groups/${id}/`)));

        state.groups = groupDetails.map((group) => {
          const students = Array.isArray(group.students) ? group.students : [];
          const parentsSet = new Set();
          students.forEach((student) => {
            const parents = Array.isArray(student.parents) ? student.parents : [];
            parents.forEach((p) => parentsSet.add(p));
          });
          return {
            id: group.id,
            name: group.name || `–ì—Ä—É–ø–ø–∞ ${group.id}`,
            students_count: students.length,
            parents_count: parentsSet.size,
          };
        });

        const savedGroupId = Number(portalSafeGet(portalKey('active_group_id')) || 0);
        const fallbackGroupId = state.groups[0] ? Number(state.groups[0].id) : null;
        state.activeGroupId = state.groups.some((g) => Number(g.id) === savedGroupId) ? savedGroupId : fallbackGroupId;
        const initialRooms = state.rooms.filter((room) => Number(room.group) === Number(state.activeGroupId));
        const savedRoomId = Number(portalSafeGet(portalKey('active_room_id')) || 0);
        state.activeRoomId = initialRooms.some((room) => Number(room.id) === savedRoomId)
          ? savedRoomId
          : (initialRooms[0] ? initialRooms[0].id : null);
        if (state.activeGroupId) portalSafeSet(portalKey('active_group_id'), state.activeGroupId);
        if (state.activeRoomId) portalSafeSet(portalKey('active_room_id'), state.activeRoomId);

        renderClasses();
        renderRooms();
        loadMessages();
        await refreshUnreadRooms();
        startUnreadPolling();

        const savedView = String(portalSafeGet(portalKey('active_view')) || '').trim();
        const allowedTeacher = new Set(['chat', 'schedule', 'methods', 'development']);
        const allowedManager = new Set(['chat', 'manage', 'events', 'feed']);
        const allowed = ROLE === 'manager' ? allowedManager : (ROLE === 'teacher' ? allowedTeacher : new Set(['chat']));
        if (savedView && allowed.has(savedView)) switchView(savedView);
      } catch (e) {
        $('status').textContent = e.message;
      }
    }

    $('new-msg').onclick = () => $('message-input').focus();
    if (ROLE === 'teacher' || ROLE === 'manager') {
      $('portal-layout').classList.add('teacher-layout');
      $('portal-tabs').style.display = 'flex';
      document.querySelectorAll('.portal-tab-btn').forEach((btn) => {
        btn.onclick = () => switchView(btn.dataset.view);
      });
      if (ROLE === 'teacher') {
        $('teacher-week-prev').onclick = () => {
          state.scheduleWeekOffset -= 1;
          renderTeacherScheduleWeek();
        };
        $('teacher-week-next').onclick = () => {
          state.scheduleWeekOffset += 1;
          renderTeacherScheduleWeek();
        };
      } else {
        document.querySelectorAll('.portal-tab-btn').forEach((btn) => {
          const view = btn.dataset.view;
          btn.style.display = (view === 'chat' || view === 'manage' || view === 'events' || view === 'feed') ? '' : 'none';
        });
        ['pane-schedule', 'pane-methods', 'pane-development'].forEach((id) => {
          const el = $(id);
          if (el) el.classList.remove('active');
        });
        initManagerAdmin().catch((e) => {
          const status = $('manager-admin-list-status');
          if (status) status.textContent = e.message;
        });
      }
    } else {
      $('pane-chat').classList.add('active');
      $('pane-schedule').classList.remove('active');
      $('pane-methods').classList.remove('active');
      const devPane = $('pane-development');
      if (devPane) devPane.classList.remove('active');
      const managePane = $('pane-manage');
      if (managePane) managePane.classList.remove('active');
    }
    $('chat-bell').onclick = () => {
      const unreadRoom = state.rooms.find((room) => state.unreadRoomIds.has(room.id));
      if (unreadRoom) {
        state.activeGroupId = Number(unreadRoom.group);
        state.activeRoomId = unreadRoom.id;
        portalSafeSet(portalKey('active_group_id'), state.activeGroupId);
        portalSafeSet(portalKey('active_room_id'), state.activeRoomId);
        state.unreadRoomIds.delete(unreadRoom.id);
        updateBellUI();
        renderClasses();
        renderRooms();
        switchView('chat');
      }
    };
    $('send-btn').onclick = sendMessage;
    $('attach-btn').onclick = () => $('attachment-input').click();
    $('attachment-input').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0] ? e.target.files[0] : null;
      state.selectedFile = file;
      updateAttachmentPill();
    });
    $('attach-clear').onclick = () => {
      state.selectedFile = null;
      $('attachment-input').value = '';
      updateAttachmentPill();
    };

    $('message-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    $('logout').onclick = async () => {
      try { await fetch('/api/session-logout/', { method: 'POST' }); } catch (_) {}
      sessionStorage.removeItem('portal_token');
      window.location.href = '/login/';
    };

    loadPortal();
  </script>
</body>
</html>
